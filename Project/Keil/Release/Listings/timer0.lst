C51 COMPILER V9.60.7.0   TIMER0                                                            07/09/2025 10:39:36 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE TIMER0
OBJECT MODULE PLACED IN .\Release\Objects\timer0.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\Hardware\timer0.c LARGE OPTIMIZE(8,SPEED) BROWSE INTVECTOR(0X000C)
                    - INCDIR(..\..\Libraries\Include;..\..\User;..\..\Hardware) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\Listings\timer
                    -0.lst) OBJECT(.\Release\Objects\timer0.obj)

line level    source

   1          #include "timer0.h"
   2          
   3          #include "ir_handle.h"
   4          #include "user_config.h"
   5          
   6          // ç‰¹æ®Šçš„LEDæ¨¡å¼ï¼Œé€€å‡ºæ—¶é—´è®¡æ•°
   7          u16 special_led_mode_times_cnt = 0;
   8          
   9          void timer0_config(void)
  10          {
  11   1          __EnableIRQ(TMR0_IRQn); // ä½¿èƒ½timer0ä¸­æ–­
  12   1          IE_EA = 1;              // ä½¿èƒ½æ€»ä¸­æ–­
  13   1      
  14   1          // è®¾ç½®timer0çš„è®¡æ•°åŠŸèƒ½ï¼Œé…ç½®ä¸€ä¸ªé¢‘ç‡ä¸º1kHzçš„ä¸­æ–­
  15   1          TMR_ALLCON = TMR0_CNT_CLR(0x1);                               // æ¸…é™¤è®¡æ•°å€¼
  16   1          TMR0_PRH = TMR_PERIOD_VAL_H((TIMER0_PERIOD_VAL >> 8) & 0xFF); // å‘¨æœŸå€¼
  17   1          TMR0_PRL = TMR_PERIOD_VAL_L((TIMER0_PERIOD_VAL >> 0) & 0xFF);
  18   1          TMR0_CONH = TMR_PRD_PND(0x1) | TMR_PRD_IRQ_EN(0x1);                          // è®¡æ•°ç­‰äºå‘¨æœŸæ—¶å
             -…è®¸å‘ç”Ÿä¸­æ–­
  19   1          TMR0_CONL = TMR_SOURCE_SEL(0x7) | TMR_PRESCALE_SEL(0x7) | TMR_MODE_SEL(0x1); // é€‰æ‹©ç³»ç»Ÿæ—¶é’Ÿï¼Œ1
             -28åˆ†é¢‘ï¼Œè®¡æ•°æ¨¡å¼
  20   1      }
  21          
  22          void TIMR0_IRQHandler(void) interrupt TMR0_IRQn
  23          {
  24   1          // è¿›å…¥ä¸­æ–­è®¾ç½®IPï¼Œä¸å¯åˆ é™¤
  25   1          __IRQnIPnPush(TMR0_IRQn);
  26   1      
  27   1          // ---------------- ç”¨æˆ·å‡½æ•°å¤„ç† -------------------
  28   1      
  29   1          // å‘¨æœŸä¸­æ–­
  30   1          if (TMR0_CONH & TMR_PRD_PND(0x1))
  31   1          {
  32   2              TMR0_CONH |= TMR_PRD_PND(0x1); // æ¸…é™¤pending
  33   2      
  34   2      #if 1     // çº¢å¤–è§£ç ã€éœ€è¦æ”¾åˆ°100usçš„å®šæ—¶å™¨ä¸­æ–­æ¥å¤„ç†ã€‘
  35   2              { // çº¢å¤–è§£ç 
  36   3                  // static volatile u8 ir_fliter;
  37   3                  static volatile u16 ir_level_cnt; // çº¢å¤–ä¿¡å·çš„ä¸‹é™æ²¿æ—¶é—´é—´éš”è®¡æ•°
  38   3                  static volatile u32 __ir_data;    //
  39   3                  static volatile bit last_level_in_ir_pin = 0;
  40   3                  // static volatile u16 ir_long_press_cnt; // æª¢æ¸¬ç´…å¤–é™æ§é•·æŒ‰çš„è¨ˆæ•¸å€¼
  41   3      
  42   3                  // å¯¹æ¯ä¸ªä¸‹é™æ²¿è¿›è¡Œè®¡æ•°
  43   3                  if (ir_level_cnt <= 1300)
  44   3                      ir_level_cnt++;
  45   3      
  46   3                  // æ»¤æ³¢æ“ä½œ
  47   3                  // ir_fliter <<= 1;
  48   3                  // if (IR_RECV_PIN)
  49   3                  // {
  50   3                  //     ir_fliter |= 1;
  51   3                  // }
C51 COMPILER V9.60.7.0   TIMER0                                                            07/09/2025 10:39:36 PAGE 2   

  52   3                  // ir_fliter &= 0x07;
  53   3      
  54   3                  // if (ir_fliter == 0x07)
  55   3                  //     filter_level = 1;
  56   3                  // else if (ir_fliter == 0x00)
  57   3                  //     filter_level = 0;
  58   3      
  59   3                  // if (filter_level)
  60   3                  if (IR_RECV_PIN)
  61   3                  {
  62   4                      last_level_in_ir_pin = 1; // è¡¨ç¤ºæ¥æ”¶åˆ°çš„æ˜¯é«˜ç”µå¹³
  63   4      
  64   4                      // å¦‚æœä¹‹å‰ä¹Ÿæ˜¯é«˜ç”µå¹³
  65   4                      if (ir_level_cnt > 1200) // è¶…æ—¶æ—¶é—´(120000us,120ms)
  66   4                      {
  67   5                          // if (__ir_data != 0) // è¶…æ—¶ï¼Œä¸”æ¥æ”¶åˆ°æ•°æ®(çº¢å¤–æ¥æ”¶å¤„ç†å‡½æ•°ä¸­ä¼šæŠ
             -Šir_dataæ¸…é›¶)
  68   5                          if (__ir_data != 0) // è¶…æ—¶ï¼Œä¸”æ¥æ”¶åˆ°æ•°æ®(ç°åœ¨æ˜¯åœ¨ä¸­æ–­æœåŠ¡å‡½æ•°ä¸­æŠ
             -Š__ir_dataè‡ªåŠ¨æ¸…é›¶)
  69   5                          {
  70   6                              // // å¸¦æ ¡éªŒçš„ç‰ˆæœ¬ï¼š
  71   6                              // if ((u8)(__ir_data >> 8) == (u8)(~__ir_data)) // å¦‚æœé”®å€¼çš„åŸç å’Œåç 
             -ç›¸ç­‰
  72   6                              // {
  73   6                              // flag_is_recved_data = 1;
  74   6                              // }
  75   6      
  76   6                              // ä¸å¸¦æ ¡éªŒçš„ç‰ˆæœ¬
  77   6                              if (0 == flag_is_recved_data)
  78   6                              {
  79   7                                  // if ((__ir_data & 0xFF0000) == 0xFF0000)
  80   7                                  {
  81   8                                      ir_data = ~__ir_data;
  82   8                                      __ir_data = 0;
  83   8                                      flag_is_recved_data = 1;
  84   8                                  }
  85   7                              }
  86   6                          }
  87   5      
  88   5                          flag_is_recv_ir_repeat_code = 0; // è®¤ä¸ºé¥æ§å™¨æŒ‰é”®å·²ç»æŒ‰ä¸‹ï¼Œç„¶åæ¾å¼€
  89   5                      }
  90   4                  }
  91   3                  else
  92   3                  {
  93   4                      if (last_level_in_ir_pin)
  94   4                      {
  95   5                          // å¦‚æœä¹‹å‰æ£€æµ‹åˆ°çš„æ˜¯é«˜ç”µå¹³ï¼Œç°åœ¨æ£€æµ‹åˆ°äº†ä½ç”µå¹³
  96   5                          if (ir_level_cnt <= 8) // å°äº800usï¼Œè¯´æ˜æ¥æ”¶åˆ°æ— æ•ˆçš„æ•°æ®ï¼Œé‡æ–°æ¥æ”¶
  97   5                          {
  98   6                              // FLAG_IS_RECVED_ERR_IR_DATA = 1;
  99   6                              flag_is_recv_ir_repeat_code = 0;
 100   6                          }
 101   5                          else if (ir_level_cnt <= 18) // å°äº1800us,è¯´æ˜æ¥æ”¶åˆ°äº†é€»è¾‘0
 102   5                          {
 103   6                              __ir_data <<= 1;
 104   6      
 105   6                              // P15D = 0; // æµ‹è¯•çº¢å¤–è§£ç 
 106   6                              // P15D = ~P15D; // æµ‹è¯•çº¢å¤–è§£ç 
 107   6                          }
 108   5                          else if (ir_level_cnt <= 26) // å°äº2600us,è¯´æ˜æ¥æ”¶åˆ°äº†é€»è¾‘1
 109   5                          {
 110   6                              __ir_data <<= 1;
C51 COMPILER V9.60.7.0   TIMER0                                                            07/09/2025 10:39:36 PAGE 3   

 111   6                              __ir_data |= 0x01;
 112   6      
 113   6                              // P15D = 1; // æµ‹è¯•çº¢å¤–è§£ç 
 114   6                          }
 115   5                          else if (ir_level_cnt <= 150) // å°äº15000us,è¯´æ˜æ¥æ”¶åˆ°äº†æ ¼å¼å¤´
 116   5                          {
 117   6                              // FLAG_IS_RECVED_ERR_IR_DATA = 1;
 118   6                              // ir_long_press_cnt = 0; // åŠ ä¸Šè¿™ä¸€æ¡ä¼šæ£€æµ‹ä¸åˆ°é•¿æŒ‰
 119   6                          }
 120   5                          else if (ir_level_cnt <= 420) // å°äº42ms,è¯´æ˜æ¥æ”¶å®Œä¸€æ¬¡å®Œæ•´çš„çº¢å¤–ä¿¡å·
 121   5                          {
 122   6      #if 0 // å¸¦æ ¡éªŒçš„ç‰ˆæœ¬ï¼Œå‘½ä»¤æºç ä¸å‘½ä»¤åç è¿›è¡Œæ ¡éªŒ
                  
                              if ((u8)(__ir_data >> 8) == (u8)(~__ir_data)) // å¦‚æœé”®å€¼çš„åŸç å’Œåç ç›¸ç­‰
                              {
                                  flag_is_recved_data = 1;
                                  flag_is_recv_ir_repeat_code = 1; //
                                  ir_long_press_cnt = 0;
                              }
              
              #else // ä¸å¸¦æ ¡éªŒçš„ç‰ˆæœ¬
 132   6      
 133   6                              if (0 == flag_is_recved_data) // å¦‚æœä¹‹å‰æœªæ¥æ”¶åˆ°æ•°æ®/æ¥æ”¶åˆ°çš„æ•°æ®
             -å·²ç»å¤„ç†å®Œæ¯•
 134   6                              {
 135   7                                  // if ((__ir_data & 0xFF0000) == 0xFF0000)
 136   7                                  {
 137   8                                      ir_data = ~__ir_data;
 138   8                                      __ir_data = 0;
 139   8                                      flag_is_recved_data = 1;
 140   8                                      // flag_is_recv_ir_repeat_code = 1; //
 141   8                                  }
 142   7                              }
 143   6      
 144   6      #endif // ä¸å¸¦æ ¡éªŒçš„ç‰ˆæœ¬
 145   6                          }
 146   5                          else if (ir_level_cnt <= 1200) // å°äº120000,120ms,è¯´æ˜æ¥æ”¶åˆ°äº†é‡å¤ç 
 147   5                          {
 148   6                              // if (ir_long_press_cnt < 65535)
 149   6                              //     ir_long_press_cnt++;
 150   6      
 151   6                              flag_is_recv_ir_repeat_code = 1;
 152   6                          }
 153   5                          // else // è¶…è¿‡120000,è¯´æ˜æ¥æ”¶åˆ°æ— æ•ˆçš„æ•°æ®
 154   5                          // {
 155   5                          // }
 156   5      
 157   5                          ir_level_cnt = 0;
 158   5                      }
 159   4      
 160   4                      last_level_in_ir_pin = 0; // è¡¨ç¤ºæ¥æ”¶åˆ°çš„æ˜¯ä½ç”µå¹³
 161   4                  }
 162   3              } // çº¢å¤–è§£ç 
 163   2      #endif // çº¢å¤–è§£ç ã€éœ€è¦æ”¾åˆ°100usçš„å®šæ—¶å™¨ä¸­æ–­æ¥å¤„ç†ã€‘
 164   2      
 165   2      #if 1 // æ§åˆ¶LEDæŒ‡ç¤ºç¯
 166   2      
 167   2              {                   // æ§åˆ¶LEDæŒ‡ç¤ºç¯--éœ€è¦æ”¾åœ¨100usçš„ä¸­æ–­
 168   3                  static u16 cnt; // ç”¨è½¯ä»¶å®ç°PWMé©±åŠ¨LEDçš„ç›¸å…³å˜é‡
 169   3                  cnt++;
 170   3      
 171   3                  if (cnt <= 20) // 20 * 100us
C51 COMPILER V9.60.7.0   TIMER0                                                            07/09/2025 10:39:36 PAGE 4   

 172   3                  {
 173   4                      if (flag_is_led_1_enable)
 174   4                      {
 175   5                          LED_1_PIN = LED_ON_LEVEL;
 176   5                      }
 177   4      
 178   4                      if (flag_is_led_2_enable)
 179   4                      {
 180   5                          LED_2_PIN = LED_ON_LEVEL;
 181   5                      }
 182   4      
 183   4                      if (flag_is_led_3_enable)
 184   4                      {
 185   5                          LED_3_PIN = LED_ON_LEVEL;
 186   5                      }
 187   4      
 188   4                      if (flag_is_led_4_enable)
 189   4                      {
 190   5                          LED_4_PIN = LED_ON_LEVEL;
 191   5                      }
 192   4      
 193   4                      if (flag_is_led_5_enable)
 194   4                      {
 195   5                          LED_5_PIN = LED_ON_LEVEL;
 196   5                      }
 197   4                  }
 198   3                  else
 199   3                  {
 200   4                      LED_1_PIN = LED_OFF_LEVEL;
 201   4                      LED_2_PIN = LED_OFF_LEVEL;
 202   4                      LED_3_PIN = LED_OFF_LEVEL;
 203   4                      LED_4_PIN = LED_OFF_LEVEL;
 204   4                      LED_5_PIN = LED_OFF_LEVEL;
 205   4                  }
 206   3      
 207   3                  if (cnt >= 100) // 100 * 100us
 208   3                  {
 209   4                      cnt = 0;
 210   4                  }
 211   3      
 212   3              } // æ§åˆ¶LEDæŒ‡ç¤ºç¯--éœ€è¦æ”¾åœ¨100usçš„ä¸­æ–­
 213   2      #endif // æ§åˆ¶LEDæŒ‡ç¤ºç¯
 214   2      
 215   2              {
 216   3                  static u8 cnt = 0;
 217   3                  static u8 blink_cnt = 0;
 218   3                  static bit flag_blink_dir = 0;
 219   3      
 220   3                  cnt++;
 221   3      
 222   3                  if (cnt >= 10) // 10 * 100us == 1ms
 223   3                  {
 224   4                      cnt = 0;
 225   4      
 226   4      #if 1 // æ§åˆ¶LEDæŒ‡ç¤ºç¯çš„é—ªçƒæ•ˆæœ
 227   4                      blink_cnt++;
 228   4                      if (blink_cnt >= 200)
 229   4                      {
 230   5                          blink_cnt = 0;
 231   5      
 232   5                          // å¤„äºåˆå§‹æ”¾ç”µæŒ¡ä½æŒ‡ç¤ºæ¨¡å¼ï¼Œæ‰è¿›å…¥
 233   5                          if (CUR_LED_MODE_INITIAL_DISCHARGE_GEAR == cur_led_mode)
C51 COMPILER V9.60.7.0   TIMER0                                                            07/09/2025 10:39:36 PAGE 5   

 234   5                          {
 235   6                              if (0 == flag_blink_dir)
 236   6                              {
 237   7                                  // LED_1_ON();
 238   7                                  switch (cur_initial_discharge_gear)
 239   7                                  {
 240   8                                  case 1:
 241   8                                      LED_1_ON();
 242   8                                      break;
 243   8                                  case 2:
 244   8                                      LED_2_ON();
 245   8                                      break;
 246   8                                  case 3:
 247   8                                      LED_3_ON();
 248   8                                      break;
 249   8                                  case 4:
 250   8                                      LED_4_ON();
 251   8                                      break;
 252   8                                  case 5:
 253   8                                      LED_5_ON();
 254   8                                      break;
 255   8                                  }
 256   7      
 257   7                                  flag_blink_dir = 1;
 258   7                              }
 259   6                              else
 260   6                              {
 261   7                                  // LED_1_OFF();
 262   7                                  switch (cur_initial_discharge_gear)
 263   7                                  {
 264   8                                  case 1:
 265   8                                      LED_1_OFF();
 266   8                                      break;
 267   8                                  case 2:
 268   8                                      LED_2_OFF();
 269   8                                      break;
 270   8                                  case 3:
 271   8                                      LED_3_OFF();
 272   8                                      break;
 273   8                                  case 4:
 274   8                                      LED_4_OFF();
 275   8                                      break;
 276   8                                  case 5:
 277   8                                      LED_5_OFF();
 278   8                                      break;
 279   8                                  }
 280   7      
 281   7                                  flag_blink_dir = 0;
 282   7                              }
 283   6                          } // if (CUR_LED_MODE_INITIAL_DISCHARGE_GEAR == cur_led_mode)
 284   5                      } // if (blink_cnt >= 200)
 285   4      #endif // æ§åˆ¶LEDæŒ‡ç¤ºç¯çš„é—ªçƒæ•ˆæœ
 286   4      
 287   4      #if 1           // é€€å‡ºç‰¹æ®Šçš„ledæŒ‡ç¤ºæ¨¡å¼çš„æ—¶é—´è®¡æ•°
 288   4                      // if (cur_led_mode != CUR_LED_MODE_BAT_INDICATOR) // ä¸å¤„äºç”µæ± ç”µé‡æŒ‡ç¤ºæ¨¡å¼ï¼Œ
             -å¼€å§‹ç´¯è®¡æ—¶é—´
 289   4                      {
 290   5                          special_led_mode_times_cnt++;
 291   5                          if (special_led_mode_times_cnt >= 5000)
 292   5                          {
 293   6                              special_led_mode_times_cnt = 0;
 294   6                              flag_is_update_led_mode_times_come = 1;
C51 COMPILER V9.60.7.0   TIMER0                                                            07/09/2025 10:39:36 PAGE 6   

 295   6                          }
 296   5                      }
 297   4      #endif // é€€å‡ºç‰¹æ®Šçš„ledæŒ‡ç¤ºæ¨¡å¼çš„æ—¶é—´è®¡æ•°
 298   4      
 299   4                  } // if (cnt >= 10) // 10 * 100us == 1ms
 300   3              }
 301   2       
 302   2      
 303   2      #if 1 // æ”¾ç”µæ—¶é—´æ§åˆ¶
 304   2      
 305   2              // TODO: å¦‚æœåœ¨å……ç”µï¼Œä¸æ‰§è¡Œè¯¥åŠŸèƒ½
 306   2              {
 307   3                  static u16 cnt = 0;
 308   3                  cnt++;
 309   3                  if (cnt >= 10000) // 10000 * 100usï¼Œ1s
 310   3                  {
 311   4                      cnt = 0;
 312   4                      flag_is_light_adjust_time_come = 1;
 313   4                  }
 314   3              }
 315   2      
 316   2      #endif // æ”¾ç”µæ—¶é—´æ§åˆ¶
 317   2      
 318   2      #if 0 // ç¼“æ…¢è°ƒèŠ‚é©±åŠ¨ç¯å…‰çš„pwmå ç©ºæ¯”
              
                      {
                          // static u8 cnt =0;
              
                          // æš‚å®šæ¯100usè°ƒèŠ‚ä¸€æ¬¡
              
                          if (cur_light_pwm_duty_val > expect_light_pwm_duty_val)
                          {
                              cur_light_pwm_duty_val--;
                          }
                          else if (cur_light_pwm_duty_val < expect_light_pwm_duty_val)
                          {
                              cur_light_pwm_duty_val++;
                          }
              
                          // SET_LIGHT_PWM_DUTY(cur_light_pwm_duty_val);
                          // timer2_set_pwm_duty(cur_light_pwm_duty_val);
                      }
              
              #endif // ç¼“æ…¢è°ƒèŠ‚é©±åŠ¨ç¯å…‰çš„pwmå ç©ºæ¯”
 339   2          }
 340   1      
 341   1          // é€€å‡ºä¸­æ–­è®¾ç½®IPï¼Œä¸å¯åˆ é™¤
 342   1          __IRQnIPnPop(TMR0_IRQn);
 343   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    789    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     14    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
