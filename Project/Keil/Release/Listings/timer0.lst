C51 COMPILER V9.60.7.0   TIMER0                                                            06/27/2025 15:21:54 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE TIMER0
OBJECT MODULE PLACED IN .\Release\Objects\timer0.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\Hardware\timer0.c OPTIMIZE(8,SPEED) BROWSE INTVECTOR(0X000C) INCDI
                    -R(..\..\Libraries\Include;..\..\User;..\..\Hardware) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\Listings\timer0.lst)
                    - OBJECT(.\Release\Objects\timer0.obj)

line level    source

   1          #include "timer0.h"
   2          
   3          #include "ir_handle.h"
   4          #include "user_config.h"
   5          
   6          void timer0_config(void)
   7          {
   8   1          __EnableIRQ(TMR0_IRQn); // ä½¿èƒ½timer0ä¸­æ–­
   9   1          IE_EA = 1;              // ä½¿èƒ½æ€»ä¸­æ–­
  10   1      
  11   1          // è®¾ç½®timer0çš„è®¡æ•°åŠŸèƒ½ï¼Œé…ç½®ä¸€ä¸ªé¢‘ç‡ä¸º1kHzçš„ä¸­æ–­
  12   1          TMR_ALLCON = TMR0_CNT_CLR(0x1);                               // æ¸…é™¤è®¡æ•°å€¼
  13   1          TMR0_PRH = TMR_PERIOD_VAL_H((TIMER0_PERIOD_VAL >> 8) & 0xFF); // å‘¨æœŸå€¼
  14   1          TMR0_PRL = TMR_PERIOD_VAL_L((TIMER0_PERIOD_VAL >> 0) & 0xFF);
  15   1          TMR0_CONH = TMR_PRD_PND(0x1) | TMR_PRD_IRQ_EN(0x1);                          // è®¡æ•°ç­‰äºå‘¨æœŸæ—¶å
             -…è®¸å‘ç”Ÿä¸­æ–­
  16   1          TMR0_CONL = TMR_SOURCE_SEL(0x7) | TMR_PRESCALE_SEL(0x7) | TMR_MODE_SEL(0x1); // é€‰æ‹©ç³»ç»Ÿæ—¶é’Ÿï¼Œ1
             -28åˆ†é¢‘ï¼Œè®¡æ•°æ¨¡å¼
  17   1      }
  18          
  19          void TIMR0_IRQHandler(void) interrupt TMR0_IRQn
  20          {
  21   1          // è¿›å…¥ä¸­æ–­è®¾ç½®IPï¼Œä¸å¯åˆ é™¤
  22   1          __IRQnIPnPush(TMR0_IRQn);
  23   1      
  24   1          // ---------------- ç”¨æˆ·å‡½æ•°å¤„ç† -------------------
  25   1      
  26   1          // å‘¨æœŸä¸­æ–­
  27   1          if (TMR0_CONH & TMR_PRD_PND(0x1))
  28   1          {
  29   2              TMR0_CONH |= TMR_PRD_PND(0x1); // æ¸…é™¤pending
  30   2      
  31   2      #if 1     // çº¢å¤–è§£ç ã€éœ€è¦æ”¾åˆ°100usçš„å®šæ—¶å™¨ä¸­æ–­æ¥å¤„ç†ã€‘
  32   2              { // çº¢å¤–è§£ç 
  33   3                  // static volatile u8 ir_fliter;
  34   3                  static volatile u16 ir_level_cnt; // çº¢å¤–ä¿¡å·çš„ä¸‹é™æ²¿æ—¶é—´é—´éš”è®¡æ•°
  35   3                  static volatile u32 __ir_data;    //
  36   3                  static volatile bit last_level_in_ir_pin = 0;
  37   3                  // static volatile u16 ir_long_press_cnt; // æª¢æ¸¬ç´…å¤–é™æ§é•·æŒ‰çš„è¨ˆæ•¸å€¼
  38   3      
  39   3                  // å¯¹æ¯ä¸ªä¸‹é™æ²¿è¿›è¡Œè®¡æ•°
  40   3                  if (ir_level_cnt <= 1300)
  41   3                      ir_level_cnt++;
  42   3      
  43   3                  // æ»¤æ³¢æ“ä½œ
  44   3                  // ir_fliter <<= 1;
  45   3                  // if (IR_RECV_PIN)
  46   3                  // {
  47   3                  //     ir_fliter |= 1;
  48   3                  // }
  49   3                  // ir_fliter &= 0x07;
  50   3      
  51   3                  // if (ir_fliter == 0x07)
C51 COMPILER V9.60.7.0   TIMER0                                                            06/27/2025 15:21:54 PAGE 2   

  52   3                  //     filter_level = 1;
  53   3                  // else if (ir_fliter == 0x00)
  54   3                  //     filter_level = 0;
  55   3      
  56   3                  // if (filter_level)
  57   3                  if (IR_RECV_PIN)
  58   3                  {
  59   4                      last_level_in_ir_pin = 1; // è¡¨ç¤ºæ¥æ”¶åˆ°çš„æ˜¯é«˜ç”µå¹³
  60   4      
  61   4                      // å¦‚æœä¹‹å‰ä¹Ÿæ˜¯é«˜ç”µå¹³
  62   4                      if (ir_level_cnt > 1200) // è¶…æ—¶æ—¶é—´(120000us,120ms)
  63   4                      {
  64   5                          // if (__ir_data != 0) // è¶…æ—¶ï¼Œä¸”æ¥æ”¶åˆ°æ•°æ®(çº¢å¤–æ¥æ”¶å¤„ç†å‡½æ•°ä¸­ä¼šæŠ
             -Šir_dataæ¸…é›¶)
  65   5                          if (__ir_data != 0) // è¶…æ—¶ï¼Œä¸”æ¥æ”¶åˆ°æ•°æ®(ç°åœ¨æ˜¯åœ¨ä¸­æ–­æœåŠ¡å‡½æ•°ä¸­æŠ
             -Š__ir_dataè‡ªåŠ¨æ¸…é›¶)
  66   5                          {
  67   6                              // // å¸¦æ ¡éªŒçš„ç‰ˆæœ¬ï¼š
  68   6                              // if ((u8)(__ir_data >> 8) == (u8)(~__ir_data)) // å¦‚æœé”®å€¼çš„åŸç å’Œåç 
             -ç›¸ç­‰
  69   6                              // {
  70   6                              // flag_is_recved_data = 1;
  71   6                              // }
  72   6      
  73   6                              // ä¸å¸¦æ ¡éªŒçš„ç‰ˆæœ¬
  74   6                              if (0 == flag_is_recved_data)
  75   6                              {
  76   7                                  // if ((__ir_data & 0xFF0000) == 0xFF0000)
  77   7                                  {
  78   8                                      ir_data = ~__ir_data;
  79   8                                      __ir_data = 0;
  80   8                                      flag_is_recved_data = 1;
  81   8                                  }
  82   7                              }
  83   6                          }
  84   5      
  85   5                          flag_is_recv_ir_repeat_code = 0; // è®¤ä¸ºé¥æ§å™¨æŒ‰é”®å·²ç»æŒ‰ä¸‹ï¼Œç„¶åæ¾å¼€
  86   5                      }
  87   4                  }
  88   3                  else
  89   3                  {
  90   4                      if (last_level_in_ir_pin)
  91   4                      {
  92   5                          // å¦‚æœä¹‹å‰æ£€æµ‹åˆ°çš„æ˜¯é«˜ç”µå¹³ï¼Œç°åœ¨æ£€æµ‹åˆ°äº†ä½ç”µå¹³
  93   5                          if (ir_level_cnt <= 8) // å°äº800usï¼Œè¯´æ˜æ¥æ”¶åˆ°æ— æ•ˆçš„æ•°æ®ï¼Œé‡æ–°æ¥æ”¶
  94   5                          {
  95   6                              // FLAG_IS_RECVED_ERR_IR_DATA = 1;
  96   6                              flag_is_recv_ir_repeat_code = 0;
  97   6                          }
  98   5                          else if (ir_level_cnt <= 18) // å°äº1800us,è¯´æ˜æ¥æ”¶åˆ°äº†é€»è¾‘0
  99   5                          {
 100   6                              __ir_data <<= 1;
 101   6      
 102   6                              // P15D = 0; // æµ‹è¯•çº¢å¤–è§£ç 
 103   6                              // P15D = ~P15D; // æµ‹è¯•çº¢å¤–è§£ç 
 104   6                          }
 105   5                          else if (ir_level_cnt <= 26) // å°äº2600us,è¯´æ˜æ¥æ”¶åˆ°äº†é€»è¾‘1
 106   5                          {
 107   6                              __ir_data <<= 1;
 108   6                              __ir_data |= 0x01;
 109   6      
 110   6                              // P15D = 1; // æµ‹è¯•çº¢å¤–è§£ç 
C51 COMPILER V9.60.7.0   TIMER0                                                            06/27/2025 15:21:54 PAGE 3   

 111   6                          }
 112   5                          else if (ir_level_cnt <= 150) // å°äº15000us,è¯´æ˜æ¥æ”¶åˆ°äº†æ ¼å¼å¤´
 113   5                          {
 114   6                              // FLAG_IS_RECVED_ERR_IR_DATA = 1;
 115   6                              // ir_long_press_cnt = 0; // åŠ ä¸Šè¿™ä¸€æ¡ä¼šæ£€æµ‹ä¸åˆ°é•¿æŒ‰
 116   6                          }
 117   5                          else if (ir_level_cnt <= 420) // å°äº42ms,è¯´æ˜æ¥æ”¶å®Œä¸€æ¬¡å®Œæ•´çš„çº¢å¤–ä¿¡å·
 118   5                          {
 119   6      #if 0 // å¸¦æ ¡éªŒçš„ç‰ˆæœ¬ï¼Œå‘½ä»¤æºç ä¸å‘½ä»¤åç è¿›è¡Œæ ¡éªŒ
                  
                              if ((u8)(__ir_data >> 8) == (u8)(~__ir_data)) // å¦‚æœé”®å€¼çš„åŸç å’Œåç ç›¸ç­‰
                              {
                                  flag_is_recved_data = 1;
                                  flag_is_recv_ir_repeat_code = 1; //
                                  ir_long_press_cnt = 0;
                              }
              
              #else // ä¸å¸¦æ ¡éªŒçš„ç‰ˆæœ¬
 129   6      
 130   6                              if (0 == flag_is_recved_data) // å¦‚æœä¹‹å‰æœªæ¥æ”¶åˆ°æ•°æ®/æ¥æ”¶åˆ°çš„æ•°æ®
             -å·²ç»å¤„ç†å®Œæ¯•
 131   6                              {
 132   7                                  // if ((__ir_data & 0xFF0000) == 0xFF0000)
 133   7                                  {
 134   8                                      ir_data = ~__ir_data;
 135   8                                      __ir_data = 0;
 136   8                                      flag_is_recved_data = 1;
 137   8                                      // flag_is_recv_ir_repeat_code = 1; //
 138   8                                  }
 139   7                              }
 140   6      
 141   6      #endif // ä¸å¸¦æ ¡éªŒçš„ç‰ˆæœ¬
 142   6                          }
 143   5                          else if (ir_level_cnt <= 1200) // å°äº120000,120ms,è¯´æ˜æ¥æ”¶åˆ°äº†é‡å¤ç 
 144   5                          {
 145   6                              // if (ir_long_press_cnt < 65535)
 146   6                              //     ir_long_press_cnt++;
 147   6      
 148   6                              flag_is_recv_ir_repeat_code = 1;
 149   6                          }
 150   5                          // else // è¶…è¿‡120000,è¯´æ˜æ¥æ”¶åˆ°æ— æ•ˆçš„æ•°æ®
 151   5                          // {
 152   5                          // }
 153   5      
 154   5                          ir_level_cnt = 0;
 155   5                      }
 156   4      
 157   4                      last_level_in_ir_pin = 0; // è¡¨ç¤ºæ¥æ”¶åˆ°çš„æ˜¯ä½ç”µå¹³
 158   4                  }
 159   3              } // çº¢å¤–è§£ç 
 160   2      #endif // çº¢å¤–è§£ç ã€éœ€è¦æ”¾åˆ°100usçš„å®šæ—¶å™¨ä¸­æ–­æ¥å¤„ç†ã€‘
 161   2      
 162   2      #if 1  // æ§åˆ¶LEDæŒ‡ç¤ºç¯
 163   2              {                   // æ§åˆ¶LEDæŒ‡ç¤ºç¯--éœ€è¦æ”¾åœ¨100usçš„ä¸­æ–­
 164   3                  static u16 cnt; // ç”¨è½¯ä»¶å®ç°PWMé©±åŠ¨LEDçš„ç›¸å…³å˜é‡
 165   3                  cnt++;
 166   3      
 167   3                  if (cnt <= 20) // 20 * 100us
 168   3                  {
 169   4                      if (flag_is_led_1_enable)
 170   4                      {
 171   5                          LED_1_PIN = LED_ON_LEVEL;
C51 COMPILER V9.60.7.0   TIMER0                                                            06/27/2025 15:21:54 PAGE 4   

 172   5                      }
 173   4      
 174   4                      if (flag_is_led_2_enable)
 175   4                      {
 176   5                          LED_2_PIN = LED_ON_LEVEL;
 177   5                      }
 178   4      
 179   4                      if (flag_is_led_3_enable)
 180   4                      {
 181   5                          LED_3_PIN = LED_ON_LEVEL;
 182   5                      }
 183   4      
 184   4                      if (flag_is_led_4_enable)
 185   4                      {
 186   5                          LED_4_PIN = LED_ON_LEVEL;
 187   5                      }
 188   4      
 189   4                      if (flag_is_led_5_enable)
 190   4                      {
 191   5                          LED_5_PIN = LED_ON_LEVEL;
 192   5                      }
 193   4                  }
 194   3                  else
 195   3                  {
 196   4                      LED_1_PIN = LED_OFF_LEVEL;
 197   4                      LED_2_PIN = LED_OFF_LEVEL;
 198   4                      LED_3_PIN = LED_OFF_LEVEL;
 199   4                      LED_4_PIN = LED_OFF_LEVEL;
 200   4                      LED_5_PIN = LED_OFF_LEVEL;
 201   4                  }
 202   3      
 203   3                  if (cnt >= 100) // 100 * 100us
 204   3                  {
 205   4                      cnt = 0;
 206   4                  }
 207   3      
 208   3              } // æ§åˆ¶LEDæŒ‡ç¤ºç¯--éœ€è¦æ”¾åœ¨100usçš„ä¸­æ–­
 209   2      #endif // æ§åˆ¶LEDæŒ‡ç¤ºç¯
 210   2          }
 211   1      
 212   1          // é€€å‡ºä¸­æ–­è®¾ç½®IPï¼Œä¸å¯åˆ é™¤
 213   1          __IRQnIPnPop(TMR0_IRQn);
 214   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    450    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      8    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
