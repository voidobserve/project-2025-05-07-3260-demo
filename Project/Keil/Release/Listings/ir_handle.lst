C51 COMPILER V9.60.7.0   IR_HANDLE                                                         07/16/2025 16:01:08 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE IR_HANDLE
OBJECT MODULE PLACED IN .\Release\Objects\ir_handle.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\ir_handle.c LARGE OPTIMIZE(8,SPEED) BROWSE INTVECTOR(0X000C) 
                    -INCDIR(..\..\Libraries\Include;..\..\User;..\..\Hardware) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\Listings\ir_han
                    -dle.lst) OBJECT(.\Release\Objects\ir_handle.obj)

line level    source

   1          #include "ir_handle.h"
   2          #include "user_config.h"
   3          
   4          volatile u8 ir_data = 0;
   5          volatile bit flag_is_recv_ir_repeat_code = 0;
   6          volatile bit flag_is_recved_data = 0;
   7          
   8          volatile bit flag_is_in_setting_mode = 0; // æ˜¯å¦å¤„äºè®¾ç½®æ¨¡å¼
   9          
  10          void refresh_led_mode_status(void)
  11          {
  12   1          // æ¯æ¬¡æŒ‰ä¸‹ï¼Œæ¸…é™¤é€€å‡ºæ—¶é—´è®¡æ—¶
  13   1          special_led_mode_times_cnt = 0;
  14   1      
  15   1          // åˆ‡æ¢LEDè¦æ˜¾ç¤ºçš„æ¨¡å¼å‰ï¼Œå…ˆå…³é—­æ‰€æœ‰æŒ‡ç¤ºç¯
  16   1          LED_1_OFF();
  17   1          LED_2_OFF();
  18   1          LED_3_OFF();
  19   1          LED_4_OFF();
  20   1          LED_5_OFF();
  21   1      }
  22          
  23          /*
  24              set_led_mode
  25          
  26              CUR_LED_MODE_BAT_INDICATOR = 0,      // ç”µæ± ç”µé‡æŒ‡ç¤ºæ¨¡å¼
  27              CUR_LED_MODE_INITIAL_DISCHARGE_GEAR, // åˆå§‹æ”¾ç”µæŒ¡ä½ -- ä» xx% PWWå¼€å§‹æ”¾ç”µ
  28              CUR_LED_MODE_DISCHARGE_RATE,         // æ”¾ç”µé€Ÿç‡
  29          */
  30          void set_led_mode_status(u8 set_led_mode, u8 val)
  31          {
  32   1          // å¦‚æœåœ¨è®¾ç½®æ¨¡å¼ï¼Œæ‰ä¼šè¿›å…¥
  33   1          if (flag_is_in_setting_mode)
  34   1          {
  35   2              if (CUR_LED_MODE_INITIAL_DISCHARGE_GEAR == set_led_mode)
  36   2              {
  37   3                  cur_initial_discharge_gear = val;
  38   3              }
  39   2              else // CUR_LED_MODE_DISCHARGE_RATE == set_led_mode
  40   2              {
  41   3                  cur_discharge_rate = val;
  42   3              }
  43   2      
  44   2              cur_led_mode = set_led_mode;
  45   2              refresh_led_mode_status();
  46   2          }
  47   1      }
  48          
  49          void ir_handle(void)
  50          {
  51   1          static u8 last_ir_data = 0;
  52   1      
  53   1          if (cur_charge_phase != CUR_CHARGE_PHASE_NONE)
C51 COMPILER V9.60.7.0   IR_HANDLE                                                         07/16/2025 16:01:08 PAGE 2   

  54   1          {
  55   2              // å¦‚æœå½“å‰æ­£åœ¨å……ç”µï¼Œç›´æ¥è¿”å›
  56   2              flag_is_recved_data = 0;
  57   2              last_ir_data = 0;
  58   2              return;
  59   2          }
  60   1      
  61   1          if (flag_is_recved_data)
  62   1          {
  63   2              flag_is_recved_data = 0;
  64   2      
  65   2              last_ir_data = ir_data;
  66   2      
  67   2              switch (ir_data)
  68   2              {
  69   3              case IR_KEY_RED:
  70   3                  // å¤§æ‘‡æ§å™¨çš„çº¢è‰²æŒ‰é”®ï¼Œå°é¥æ§å™¨çš„ç»¿è‰²æŒ‰é”®
  71   3      
  72   3                  if (flag_is_in_setting_mode)
  73   3                  {
  74   4                      // æ­£å¤„äºè®¾ç½®æ¨¡å¼ï¼Œä¸å“åº”
  75   4                      return;
  76   4                  }
  77   3      
  78   3                  refresh_led_mode_status();
  79   3      
  80   3                  /*
  81   3                      ä¸åœ¨è®¾ç½®æ¨¡å¼ï¼Œæ¯æ¬¡æŒ‰ä¸‹æŒ‰é”®ï¼Œåœ¨
  82   3                      ç”µæ± ç”µé‡æŒ‡ç¤º -> åˆå§‹æ”¾ç”µæŒ¡ä½ -> æ”¾ç”µé€Ÿç‡ -> ç”µæ± ç”µé‡æŒ‡ç¤º ä¹‹é—´åˆ‡æ
             -¢
  83   3                  */
  84   3                  cur_led_mode++;
  85   3                  if (cur_led_mode > CUR_LED_MODE_DISCHARGE_RATE)
  86   3                  {
  87   4                      cur_led_mode = CUR_LED_MODE_BAT_INDICATOR;
  88   4                  }
  89   3      
  90   3                  break;
  91   3      
  92   3              case IR_KEY_NUM_1:
  93   3                  // æ•°å­—1
  94   3      
  95   3                  set_led_mode_status(CUR_LED_MODE_INITIAL_DISCHARGE_GEAR, 1);
  96   3      
  97   3                  break;
  98   3      
  99   3              case IR_KEY_BRIGHTNESS_SUB_OR_NUM_2:
 100   3                  // äº®åº¦å‡ï¼Œä¹Ÿæ˜¯å°é¥æ§å™¨çš„æ•°å­—2
 101   3                  // TODOï¼šå¾…å®Œå–„åŠŸèƒ½
 102   3      
 103   3                  set_led_mode_status(CUR_LED_MODE_INITIAL_DISCHARGE_GEAR, 2);
 104   3      
 105   3                  break;
 106   3      
 107   3              case IR_KEY_3H_OR_NUM_3:
 108   3                  // 3Hï¼Œä¹Ÿæ˜¯å°é¥æ§å™¨çš„æ•°å­—3
 109   3                  // TODOï¼šå¾…å®Œå–„åŠŸèƒ½
 110   3      
 111   3                  set_led_mode_status(CUR_LED_MODE_INITIAL_DISCHARGE_GEAR, 3);
 112   3      
 113   3                  break;
 114   3      
C51 COMPILER V9.60.7.0   IR_HANDLE                                                         07/16/2025 16:01:08 PAGE 3   

 115   3              case IR_KEY_BRIGHTNESS_ADD_OR_NUM_4:
 116   3                  // äº®åº¦åŠ ï¼Œä¹Ÿæ˜¯å°é¥æ§å™¨çš„æ•°å­—4
 117   3                  // TODOï¼šå¾…å®Œå–„åŠŸèƒ½
 118   3      
 119   3                  set_led_mode_status(CUR_LED_MODE_INITIAL_DISCHARGE_GEAR, 4);
 120   3      
 121   3                  break;
 122   3      
 123   3              case IR_KEY_AUTO_OR_NUM_5:
 124   3                  // è‡ªåŠ¨æ¨¡å¼ ï¼Œä¹Ÿæ˜¯å°é¥æ§å™¨çš„æ•°å­—5
 125   3                  // TODOï¼šå¾…å®Œå–„åŠŸèƒ½
 126   3      
 127   3                  set_led_mode_status(CUR_LED_MODE_INITIAL_DISCHARGE_GEAR, 5);
 128   3      
 129   3                  break;
 130   3      
 131   3              case IR_KEY_5H_OR_M1:
 132   3                  // 5Hï¼Œä¹Ÿæ˜¯å°é¥æ§å™¨çš„M1
 133   3                  // TODOï¼šå¾…å®Œå–„åŠŸèƒ½
 134   3      
 135   3                  set_led_mode_status(CUR_LED_MODE_DISCHARGE_RATE, 1);
 136   3      
 137   3                  break;
 138   3      
 139   3              case IR_KEY_M2:
 140   3                  // å°é¥æ§å™¨çš„M2
 141   3      
 142   3                  set_led_mode_status(CUR_LED_MODE_DISCHARGE_RATE, 2);
 143   3      
 144   3                  break;
 145   3      
 146   3              case IR_KEY_8H_OR_M3:
 147   3                  // 8Hï¼Œä¹Ÿæ˜¯å°é¥æ§å™¨çš„M3
 148   3                  // TODOï¼šå¾…å®Œå–„åŠŸèƒ½
 149   3      
 150   3                  set_led_mode_status(CUR_LED_MODE_DISCHARGE_RATE, 3);
 151   3      
 152   3                  break;
 153   3      
 154   3              case IR_KEY_SET:
 155   3                  // SET æ¨¡å¼è®¾ç½®
 156   3      
 157   3                  flag_is_in_setting_mode = 1; // è¡¨ç¤ºè¿›å…¥è®¾ç½®æ¨¡å¼
 158   3                  refresh_led_mode_status();
 159   3                  cur_led_mode = CUR_LED_MODE_SETTING; // äº¤ç»™å®šæ—¶å™¨å¤„ç†ï¼Œè®©æ‰€æœ‰æŒ‡ç¤ºç¯éƒ½é—ªçƒ
 160   3      
 161   3                  break;
 162   3      
 163   3              case IR_KEY_ON:
 164   3                  // å¼€ç¯
 165   3      
 166   3                  /* æ ¹æ®åˆå§‹çš„æ”¾ç”µæŒ¡ä½æ¥è®¾å®šç¯å…‰å¯¹åº”çš„pwmå ç©ºæ¯” */
 167   3                  switch (cur_initial_discharge_gear)
 168   3                  {
 169   4                  case 1:
 170   4                      // åˆå§‹æ”¾ç”µæŒ¡ä½ 1æ¡£ï¼Œåˆšå¼€å§‹æ˜¯ 83.67%å¼€å§‹æ”¾ç”µ
 171   4      
 172   4                      // å®šæ—¶å™¨å¯¹åº”çš„é‡è£…è½½å€¼æœ€å¤§å€¼ å¯¹åº” 100%å ç©ºæ¯”
 173   4                      expect_light_pwm_duty_val = ((u32)TIMER2_FEQ * 8367 / 10000);
 174   4      
 175   4                      break;
 176   4      
C51 COMPILER V9.60.7.0   IR_HANDLE                                                         07/16/2025 16:01:08 PAGE 4   

 177   4                  case 2:
 178   4                      // åˆå§‹æ”¾ç”µæŒ¡ä½ 2æ¡£ï¼Œåˆšå¼€å§‹æ˜¯ 74.11%å¼€å§‹æ”¾ç”µ
 179   4      
 180   4                      // å®šæ—¶å™¨å¯¹åº”çš„é‡è£…è½½å€¼æœ€å¤§å€¼ å¯¹åº” 100%å ç©ºæ¯”
 181   4                      expect_light_pwm_duty_val = ((u32)TIMER2_FEQ * 7411 / 10000);
 182   4      
 183   4                      break;
 184   4      
 185   4                  case 3:
 186   4                      // åˆå§‹æ”¾ç”µæŒ¡ä½ 3æ¡£ï¼Œåˆšå¼€å§‹æ˜¯ 64.55%å¼€å§‹æ”¾ç”µ
 187   4      
 188   4                      // å®šæ—¶å™¨å¯¹åº”çš„é‡è£…è½½å€¼æœ€å¤§å€¼ å¯¹åº” 100%å ç©ºæ¯”
 189   4                      expect_light_pwm_duty_val = ((u32)TIMER2_FEQ * 6455 / 10000);
 190   4      
 191   4                      break;
 192   4      
 193   4                  case 4:
 194   4                      // åˆå§‹æ”¾ç”µæŒ¡ä½ 4æ¡£ï¼Œåˆšå¼€å§‹æ˜¯ 56.98%å¼€å§‹æ”¾ç”µ
 195   4      
 196   4                      // å®šæ—¶å™¨å¯¹åº”çš„é‡è£…è½½å€¼æœ€å¤§å€¼ å¯¹åº” 100%å ç©ºæ¯”
 197   4                      expect_light_pwm_duty_val = ((u32)TIMER2_FEQ * 5698 / 10000);
 198   4      
 199   4                      break;
 200   4      
 201   4                  case 5:
 202   4                      // åˆå§‹æ”¾ç”µæŒ¡ä½ 5æ¡£ï¼Œåˆšå¼€å§‹æ˜¯ 49.8%å¼€å§‹æ”¾ç”µ
 203   4      
 204   4                      // å®šæ—¶å™¨å¯¹åº”çš„é‡è£…è½½å€¼æœ€å¤§å€¼ å¯¹åº” 100%å ç©ºæ¯”
 205   4                      expect_light_pwm_duty_val = ((u32)TIMER2_FEQ * 4980 / 10000);
 206   4      
 207   4                      break;
 208   4                  }
 209   3      
 210   3                  cur_light_pwm_duty_val = expect_light_pwm_duty_val;
 211   3                  // SET_LIGHT_PWM_DUTY(cur_light_pwm_duty_val);
 212   3                  timer2_set_pwm_duty(cur_light_pwm_duty_val); // ç«‹åˆ»æ›´æ–°PWMå ç©ºæ¯”
 213   3                  LIGHT_ON();                                  // ä½¿èƒ½PWMè¾“å‡º
 214   3                  light_blink();
 215   3                  refresh_led_mode_status();
 216   3                  cur_led_mode = CUR_LED_MODE_BAT_INDICATOR;
 217   3      
 218   3                  break;
 219   3      
 220   3              case IR_KEY_OFF:
 221   3      
 222   3              // TODO: å¦‚æœæœªå…³æœº
 223   3                  if (expect_light_pwm_duty_val > 0 && /* å¦‚æœç¯å…‰è¿˜æ˜¯äº®çš„ */
 224   3                        CUR_CHARGE_PHASE_NONE == cur_charge_phase)  /* å½“å‰æœªåœ¨å……ç”µ */
 225   3                  {
 226   4                      light_blink();
 227   4                      // LIGHT_OFF() // light_blink() æœ€åå°±æ˜¯å…³ç¯æ“ä½œï¼Œå¯ä»¥ä¸å†™è¿™ä¸€å¥
 228   4                      expect_light_pwm_duty_val = 0;
 229   4                      cur_light_pwm_duty_val = 0;
 230   4                      timer2_set_pwm_duty(0);
 231   4                      LIGHT_OFF();
 232   4                      cur_led_mode = CUR_LED_MODE_OFF;
 233   4                  }
 234   3      
 235   3                  break;
 236   3      
 237   3              } // switch (ir_data)
 238   2          } // if (flag_is_recved_data)
C51 COMPILER V9.60.7.0   IR_HANDLE                                                         07/16/2025 16:01:08 PAGE 5   

 239   1      
 240   1          if (flag_is_recv_ir_repeat_code)
 241   1          {
 242   2              flag_is_recv_ir_repeat_code = 0;
 243   2          }
 244   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    394    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      2    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      3    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
