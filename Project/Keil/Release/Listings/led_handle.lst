C51 COMPILER V9.60.7.0   LED_HANDLE                                                        07/17/2025 14:33:58 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE LED_HANDLE
OBJECT MODULE PLACED IN .\Release\Objects\led_handle.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\led_handle.c LARGE OPTIMIZE(8,SPEED) BROWSE INTVECTOR(0X000C)
                    - INCDIR(..\..\Libraries\Include;..\..\User;..\..\Hardware) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\Listings\led_h
                    -andle.lst) OBJECT(.\Release\Objects\led_handle.obj)

line level    source

   1          #include "led_handle.h"
   2          
   3          // TODO:需要初始化为5
   4          // volatile u8 bat_remaining_power_indication = 5; // 电池剩余电量指示挡位
   5          
   6          volatile u8 flag_led_exit_setting_times_come = 0; // 标志位，led退出设置模式的时间到来
   7          
   8          /**
   9           * @brief 更新led指示灯相关的状态
  10           *          当 cur_led_mode 改变时，会调用此函数，
  11           *          并且要放在 led_handle_update_percent_of_bat() 函数前
  12           *
  13           */
  14          void led_status_refresh(void)
  15          {
  16   1          LED_1_OFF();
  17   1          LED_2_OFF();
  18   1          LED_3_OFF();
  19   1          LED_4_OFF();
  20   1          LED_5_OFF();
  21   1          last_led_gear = 0; // 赋值为初始值
  22   1          cur_led_gear_in_charging = 0;
  23   1      
  24   1          led_mode_setting_exit_times_cnt = 0; // 清除设置模式下的退出时间计时
  25   1      }
  26          
  27          /**
  28           * @brief 更改led_mode
  29           *
  30           * @param led_mode
  31           *              CUR_LED_MODE_OFF = 0,                // 关机，指示灯全灭
  32                          CUR_LED_MODE_BAT_INDICATOR,          // 电池电量指示模式
  33                          CUR_LED_MODE_INITIAL_DISCHARGE_GEAR, // 初始放电挡位 -- 从 xx% PWW开始放电（
             -示灯由定时器控制）
  34                          CUR_LED_MODE_DISCHARGE_RATE,         // 放电速率
  35                          CUR_LED_MODE_CHARGING,               // 充电指示模式
  36                          CUR_LED_MODE_SETTING,                // 刚用遥控器按下SET按键，未按下其他
             -键，5个指示灯会一起闪烁（指示灯由定时器控制）
  37           */
  38          void led_mode_alter(u8 led_mode)
  39          {
  40   1          led_status_refresh();
  41   1      
  42   1          cur_led_mode = led_mode;
  43   1      }
  44          
  45          //
  46          void led_handle(void)
  47          {
  48   1          if (CUR_LED_MODE_OFF == cur_led_mode)
  49   1          {
  50   2              led_status_refresh();
  51   2              return;
C51 COMPILER V9.60.7.0   LED_HANDLE                                                        07/17/2025 14:33:58 PAGE 2   

  52   2          }
  53   1      
  54   1          // 如果当前处于电池电量指示模式
  55   1          // 设备处于放电时，电量指示灯只显示电池电量降低的部分
  56   1          if (CUR_LED_MODE_BAT_INDICATOR == cur_led_mode)
  57   1          {
  58   2              /* 点亮指示灯1（放电模式，指示灯1始终点亮） */
  59   2              LED_1_ON();
  60   2      
  61   2              if (bat_adc_val > BAT_ADC_VAL_4) // 电池电量大于4格
  62   2              {
  63   3                  cur_led_gear = 5; // 亮5格
  64   3              }
  65   2              else if (bat_adc_val > BAT_ADC_VAL_3) // 电池电量大于3格
  66   2              {
  67   3                  cur_led_gear = 4; // 亮4格
  68   3              }
  69   2              else if (bat_adc_val > BAT_ADC_VAL_2) // 电池电量大于2格
  70   2              {
  71   3                  cur_led_gear = 3; // 亮3格
  72   3              }
  73   2              else if (bat_adc_val > BAT_ADC_VAL_1) // 电池电量大于1格
  74   2              {
  75   3                  cur_led_gear = 2; // 亮2格
  76   3              }
  77   2              else
  78   2              {
  79   3                  cur_led_gear = 1; // 亮1格
  80   3              }
  81   2      
  82   2              if (0 == last_led_gear)
  83   2              {
  84   3                  // 如果未初始化
  85   3                  last_led_gear = cur_led_gear;
  86   3              }
  87   2              else
  88   2              {
  89   3                  // 如果 last_led_gear 不为0，则说明已经初始化过了
  90   3      
  91   3                  if (cur_led_gear > last_led_gear)
  92   3                  {
  93   4                      // 如果当前要显示的指示灯 大于 上次显示的指示灯（样机在电池电
             -上升的情况下，不会更新显示）
  94   4                      cur_led_gear = last_led_gear;
  95   4                  }
  96   3              }
  97   2      
  98   2              if (cur_led_gear >= 5)
  99   2              {
 100   3                  LED_5_ON();
 101   3              }
 102   2              else
 103   2              {
 104   3                  LED_5_OFF();
 105   3              }
 106   2      
 107   2              if (cur_led_gear >= 4)
 108   2              {
 109   3                  LED_4_ON();
 110   3              }
 111   2              else
 112   2              {
C51 COMPILER V9.60.7.0   LED_HANDLE                                                        07/17/2025 14:33:58 PAGE 3   

 113   3                  LED_4_OFF();
 114   3              }
 115   2      
 116   2              if (cur_led_gear >= 3)
 117   2              {
 118   3                  LED_3_ON();
 119   3              }
 120   2              else
 121   2              {
 122   3                  LED_3_OFF();
 123   3              }
 124   2      
 125   2              if (cur_led_gear >= 2)
 126   2              {
 127   3                  LED_2_ON();
 128   3              }
 129   2              else
 130   2              {
 131   3                  LED_2_OFF();
 132   3              }
 133   2      
 134   2          } // if (CUR_LED_MODE_BAT_INDICATOR == cur_led_mode)
 135   1          else if (CUR_LED_MODE_DISCHARGE_RATE == cur_led_mode) // 放电速率指示模式，M1、M2、M3
 136   1          {
 137   2              switch (cur_discharge_rate)
 138   2              {
 139   3              case 1:
 140   3                  LED_1_ON();
 141   3                  break;
 142   3              case 2:
 143   3                  LED_2_ON();
 144   3                  break;
 145   3              case 3:
 146   3                  LED_3_ON();
 147   3                  break;
 148   3              }
 149   2          }
 150   1          else if (CUR_LED_MODE_CHARGING == cur_led_mode) // 充电指示模式
 151   1          {
 152   2              // 在充电指示模式中，如果电池电量降低，不更新显示
 153   2              // TODO：样机是在电池电压超过3.55V并且进入涓流充电，绿色指示灯才一直
             -亮(第5格指示灯)
 154   2      
 155   2              /* 点亮指示灯1（指示灯1始终点亮） */
 156   2              LED_1_ON();
 157   2      
 158   2              // if (bat_adc_val > BAT_ADC_VAL_5) // 电池电量大于5格
 159   2              // {
 160   2              //     cur_led_gear = 6; // 亮5格，并且所有指示灯常亮
 161   2              // }
 162   2              // else if (bat_adc_val > BAT_ADC_VAL_4) // 电池电量大于4格
 163   2              if (bat_adc_val > BAT_ADC_VAL_4) // 电池电量大于4格
 164   2              {
 165   3                  cur_led_gear = 5; // 亮5格，让第5格闪烁
 166   3              }
 167   2              else if (bat_adc_val > BAT_ADC_VAL_3) // 电池电量大于3格
 168   2              {
 169   3                  cur_led_gear = 4; // 亮4格，让第4格闪烁
 170   3              }
 171   2              else if (bat_adc_val > BAT_ADC_VAL_2) // 电池电量大于2格
 172   2              {
 173   3                  cur_led_gear = 3; // 亮3格，让第3格闪烁
C51 COMPILER V9.60.7.0   LED_HANDLE                                                        07/17/2025 14:33:58 PAGE 4   

 174   3              }
 175   2              else if (bat_adc_val > BAT_ADC_VAL_1) // 电池电量大于1格
 176   2              {
 177   3                  cur_led_gear = 2; // 亮2格，让第2格闪烁
 178   3              }
 179   2              else
 180   2              {
 181   3                  cur_led_gear = 1; // 亮1格，让第2格闪烁
 182   3              }
 183   2      
 184   2              if (CUR_CHARGE_PHASE_TRICKLE_CHARGE_WHEN_APPROACH_FULLY_CHARGE == cur_charge_phase || /* 快满电
             -，涓流充电 */
 185   2                  CUR_CHARGE_PHASE_FULLY_CHARGE == cur_charge_phase)                                /* 已经充
             -满电 */
 186   2              {
 187   3                  // 样机是进入涓流充电才把所有指示灯变为常亮
 188   3                  cur_led_gear = 6;
 189   3              }
 190   2      
 191   2              if (0 == last_led_gear)
 192   2              {
 193   3                  last_led_gear = cur_led_gear;
 194   3              }
 195   2              else
 196   2              {
 197   3                  if (cur_led_gear < last_led_gear)
 198   3                  {
 199   4                      // 在充电指示模式中，如果电池电量降低，不更新显示
 200   4                      cur_led_gear = last_led_gear;
 201   4                  }
 202   3              }
 203   2      
 204   2              cur_led_gear_in_charging = cur_led_gear; // 更新数值，给定时器中断使用
 205   2              delay_ms(1);
 206   2      
 207   2              if (cur_led_gear >= 3)
 208   2              {
 209   3                  LED_2_ON();
 210   3              }
 211   2      
 212   2              if (cur_led_gear >= 4)
 213   2              {
 214   3                  LED_3_ON();
 215   3              }
 216   2      
 217   2              if (cur_led_gear >= 5)
 218   2              {
 219   3                  LED_4_ON();
 220   3              }
 221   2      
 222   2              if (cur_led_gear >= 6)
 223   2              {
 224   3                  LED_5_ON();
 225   3              }
 226   2          }
 227   1      
 228   1          if (flag_led_exit_setting_times_come) // 时间到来，回到电池电量指示模式
 229   1          {
 230   2              flag_led_exit_setting_times_come = 0;
 231   2      
 232   2              // TODO：这里还未处理好切换问题
 233   2              if (cur_light_pwm_duty_val) // 如果灯光还是亮着的
C51 COMPILER V9.60.7.0   LED_HANDLE                                                        07/17/2025 14:33:58 PAGE 5   

 234   2              {
 235   3                  cur_led_mode = CUR_LED_MODE_BAT_INDICATOR; // 恢复到电池电量指示模式
 236   3              }
 237   2              else // 如果灯光已经熄灭
 238   2              {
 239   3                  cur_led_mode = CUR_LED_MODE_OFF; // 恢复到关机模式
 240   3              }
 241   2      
 242   2              flag_is_in_setting_mode = 0; // 退出设置模式
 243   2          }
 244   1      
 245   1          if (CUR_LED_MODE_OFF == cur_led_mode)
 246   1          {
 247   2              LED_1_OFF();
 248   2              LED_2_OFF();
 249   2              LED_3_OFF();
 250   2              LED_4_OFF();
 251   2              LED_5_OFF();
 252   2          }
 253   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    657    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      1    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
