C51 COMPILER V9.60.7.0   LED_HANDLE                                                        07/18/2025 17:51:09 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE LED_HANDLE
OBJECT MODULE PLACED IN .\Release\Objects\led_handle.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\led_handle.c LARGE OPTIMIZE(8,SPEED) BROWSE INTVECTOR(0X000C)
                    - INCDIR(..\..\Libraries\Include;..\..\User;..\..\Hardware) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\Listings\led_h
                    -andle.lst) OBJECT(.\Release\Objects\led_handle.obj)

line level    source

   1          #include "led_handle.h"
   2          
   3          /**
   4           * @brief æ›´æ–°ledæŒ‡ç¤ºç¯ç›¸å…³çš„çŠ¶æ€
   5           *          å½“ cur_led_mode æ”¹å˜æ—¶ï¼Œä¼šè°ƒç”¨æ­¤å‡½æ•°ï¼Œ
   6           *          å¹¶ä¸”è¦æ”¾åœ¨ led_handle_update_percent_of_bat() å‡½æ•°å‰
   7           *
   8           */
   9          void led_status_refresh(void)
  10          {
  11   1          LED_1_OFF();
  12   1          LED_2_OFF();
  13   1          LED_3_OFF();
  14   1          LED_4_OFF();
  15   1          LED_5_OFF();
  16   1          last_led_gear = 0;            // èµ‹å€¼ä¸ºåˆå§‹å€¼
  17   1          cur_led_gear_in_charging = 0; // è¿™ä¸ªå˜é‡åº”è¯¥åœ¨åˆšä¸Šç”µæˆ–æ˜¯æ–­å¼€å……ç”µæ—¶æ¸…é›¶
  18   1      
  19   1          led_setting_mode_exit_times_cnt = 0; // æ¸…é™¤è®¾ç½®æ¨¡å¼ä¸‹çš„é€€å‡ºæ—¶é—´è®¡æ—¶
  20   1      }
  21          
  22          void led_init(void)
  23          {
  24   1          LED_1_OFF();
  25   1          LED_2_OFF();
  26   1          LED_3_OFF();
  27   1          LED_4_OFF();
  28   1          LED_5_OFF();
  29   1          last_led_gear = 0; // èµ‹å€¼ä¸ºåˆå§‹å€¼
  30   1          cur_led_gear_in_charging = 0;
  31   1          led_setting_mode_exit_times_cnt = 0; // æ¸…é™¤è®¾ç½®æ¨¡å¼ä¸‹çš„é€€å‡ºæ—¶é—´è®¡æ—¶
  32   1          flag_is_led_mode_exit_enable = 0;
  33   1      }
  34          
  35          void led_all_off(void)
  36          {
  37   1          LED_1_OFF();
  38   1          LED_2_OFF();
  39   1          LED_3_OFF();
  40   1          LED_4_OFF();
  41   1          LED_5_OFF();
  42   1      }
  43          
  44          /**
  45           * @brief æ›´æ”¹led_mode
  46           *
  47           * @param led_mode
  48           *              ç›¸å…³å®šä¹‰åœ¨ æšä¸¾ç±»å‹ CUR_LED_MODE_XXX ä¸­
  49           *
  50           *              CUR_LED_MODE_OFF = 0,                // å…³æœºï¼ŒæŒ‡ç¤ºç¯å…¨ç­
  51                          CUR_LED_MODE_BAT_INDICATOR,          // ç”µæ± ç”µé‡æŒ‡ç¤ºæ¨¡å¼
  52                          CUR_LED_MODE_INITIAL_DISCHARGE_GEAR, // åˆå§‹æ”¾ç”µæŒ¡ä½ -- ä» xx% PWWå¼€å§‹æ”¾ç”µï¼ˆæŒ
             -‡ç¤ºç¯ç”±å®šæ—¶å™¨æ§åˆ¶ï¼‰
C51 COMPILER V9.60.7.0   LED_HANDLE                                                        07/18/2025 17:51:09 PAGE 2   

  53                          CUR_LED_MODE_DISCHARGE_RATE,         // æ”¾ç”µé€Ÿç‡
  54                          CUR_LED_MODE_CHARGING,               // å……ç”µæŒ‡ç¤ºæ¨¡å¼
  55                          CUR_LED_MODE_SETTING,                // åˆšç”¨é¥æ§å™¨æŒ‰ä¸‹SETæŒ‰é”®ï¼ŒæœªæŒ‰ä¸‹å…¶ä»–æŒ
             -‰é”®ï¼Œ5ä¸ªæŒ‡ç¤ºç¯ä¼šä¸€èµ·é—ªçƒï¼ˆæŒ‡ç¤ºç¯ç”±å®šæ—¶å™¨æ§åˆ¶ï¼‰
  56           */
  57          void led_mode_alter(u8 led_mode)
  58          {
  59   1          // led_status_refresh();
  60   1          led_all_off();
  61   1      
  62   1          cur_led_mode = led_mode;
  63   1      }
  64          
  65          //
  66          void led_handle(void)
  67          {
  68   1          if (CUR_LED_MODE_OFF == cur_led_mode)
  69   1          {
  70   2              // led_status_refresh();
  71   2              led_all_off();
  72   2              return;
  73   2          }
  74   1      
  75   1          // å¦‚æœå½“å‰å¤„äºç”µæ± ç”µé‡æŒ‡ç¤ºæ¨¡å¼
  76   1          // è®¾å¤‡å¤„äºæ”¾ç”µæ—¶ï¼Œç”µé‡æŒ‡ç¤ºç¯åªæ˜¾ç¤ºç”µæ± ç”µé‡é™ä½çš„éƒ¨åˆ†
  77   1          if (CUR_LED_MODE_BAT_INDICATOR == cur_led_mode)
  78   1          {
  79   2              /* ç‚¹äº®æŒ‡ç¤ºç¯1ï¼ˆæ”¾ç”µæ¨¡å¼ï¼ŒæŒ‡ç¤ºç¯1å§‹ç»ˆç‚¹äº®ï¼‰ */
  80   2              LED_1_ON();
  81   2      
  82   2              if (bat_adc_val > BAT_ADC_VAL_4) // ç”µæ± ç”µé‡å¤§äº4æ ¼
  83   2              {
  84   3                  cur_led_gear = 5; // äº®5æ ¼
  85   3              }
  86   2              else if (bat_adc_val > BAT_ADC_VAL_3) // ç”µæ± ç”µé‡å¤§äº3æ ¼
  87   2              {
  88   3                  cur_led_gear = 4; // äº®4æ ¼
  89   3              }
  90   2              else if (bat_adc_val > BAT_ADC_VAL_2) // ç”µæ± ç”µé‡å¤§äº2æ ¼
  91   2              {
  92   3                  cur_led_gear = 3; // äº®3æ ¼
  93   3              }
  94   2              else if (bat_adc_val > BAT_ADC_VAL_1) // ç”µæ± ç”µé‡å¤§äº1æ ¼
  95   2              {
  96   3                  cur_led_gear = 2; // äº®2æ ¼
  97   3              }
  98   2              else
  99   2              {
 100   3                  cur_led_gear = 1; // äº®1æ ¼
 101   3              }
 102   2      
 103   2              if (0 == last_led_gear)
 104   2              {
 105   3                  // å¦‚æœæœªåˆå§‹åŒ–
 106   3                  last_led_gear = cur_led_gear;
 107   3              }
 108   2              else
 109   2              {
 110   3                  // å¦‚æœ last_led_gear ä¸ä¸º0ï¼Œåˆ™è¯´æ˜å·²ç»åˆå§‹åŒ–è¿‡äº†
 111   3      
 112   3                  if (cur_led_gear > last_led_gear)
 113   3                  {
C51 COMPILER V9.60.7.0   LED_HANDLE                                                        07/18/2025 17:51:09 PAGE 3   

 114   4                      // å¦‚æœå½“å‰è¦æ˜¾ç¤ºçš„æŒ‡ç¤ºç¯ å¤§äº ä¸Šæ¬¡æ˜¾ç¤ºçš„æŒ‡ç¤ºç¯ï¼ˆæ ·æœºåœ¨ç”µæ± ç”µå
             -‹ä¸Šå‡çš„æƒ…å†µä¸‹ï¼Œä¸ä¼šæ›´æ–°æ˜¾ç¤ºï¼‰
 115   4                      cur_led_gear = last_led_gear;
 116   4                  }
 117   3              }
 118   2      
 119   2              if (cur_led_gear >= 5)
 120   2              {
 121   3                  LED_5_ON();
 122   3              }
 123   2              else
 124   2              {
 125   3                  LED_5_OFF();
 126   3              }
 127   2      
 128   2              if (cur_led_gear >= 4)
 129   2              {
 130   3                  LED_4_ON();
 131   3              }
 132   2              else
 133   2              {
 134   3                  LED_4_OFF();
 135   3              }
 136   2      
 137   2              if (cur_led_gear >= 3)
 138   2              {
 139   3                  LED_3_ON();
 140   3              }
 141   2              else
 142   2              {
 143   3                  LED_3_OFF();
 144   3              }
 145   2      
 146   2              if (cur_led_gear >= 2)
 147   2              {
 148   3                  LED_2_ON();
 149   3              }
 150   2              else
 151   2              {
 152   3                  LED_2_OFF();
 153   3              }
 154   2      
 155   2          } // if (CUR_LED_MODE_BAT_INDICATOR == cur_led_mode)
 156   1          else if (CUR_LED_MODE_DISCHARGE_RATE_IN_SETTING_MODE == cur_led_mode ||
 157   1                   CUR_LED_MODE_DISCHARGE_RATE_IN_INSTRUCTION_MODE == cur_led_mode) 
 158   1          {
 159   2              // æ”¾ç”µé€Ÿç‡æŒ‡ç¤ºæ¨¡å¼ï¼ŒM1ã€M2ã€M3ï¼Œéœ€è¦å¯¹åº”çš„æŒ‡ç¤ºç¯å¸¸äº®
 160   2              switch (cur_discharge_rate)
 161   2              {
 162   3              case 1:
 163   3                  LED_1_ON();
 164   3                  break;
 165   3              case 2:
 166   3                  LED_2_ON();
 167   3                  break;
 168   3              case 3:
 169   3                  LED_3_ON();
 170   3                  break;
 171   3              }
 172   2          }
 173   1          else if (CUR_LED_MODE_CHARGING == cur_led_mode) // å……ç”µæŒ‡ç¤ºæ¨¡å¼
 174   1          {
C51 COMPILER V9.60.7.0   LED_HANDLE                                                        07/18/2025 17:51:09 PAGE 4   

 175   2              // åœ¨å……ç”µæŒ‡ç¤ºæ¨¡å¼ä¸­ï¼Œå¦‚æœç”µæ± ç”µé‡é™ä½ï¼Œä¸æ›´æ–°æ˜¾ç¤º
 176   2              // TODOï¼šæ ·æœºæ˜¯åœ¨ç”µæ± ç”µå‹è¶…è¿‡3.55Vå¹¶ä¸”è¿›å…¥æ¶“æµå……ç”µï¼Œç»¿è‰²æŒ‡ç¤ºç¯æ‰ä¸€ç›´ç‚
             -¹äº®(ç¬¬5æ ¼æŒ‡ç¤ºç¯)
 177   2      
 178   2              /* ç‚¹äº®æŒ‡ç¤ºç¯1ï¼ˆæŒ‡ç¤ºç¯1å§‹ç»ˆç‚¹äº®ï¼‰ */
 179   2              LED_1_ON();
 180   2      
 181   2              // if (bat_adc_val > BAT_ADC_VAL_5) // ç”µæ± ç”µé‡å¤§äº5æ ¼
 182   2              // {
 183   2              //     cur_led_gear = 6; // äº®5æ ¼ï¼Œå¹¶ä¸”æ‰€æœ‰æŒ‡ç¤ºç¯å¸¸äº®
 184   2              // }
 185   2              // else if (bat_adc_val > BAT_ADC_VAL_4) // ç”µæ± ç”µé‡å¤§äº4æ ¼
 186   2              if (bat_adc_val > BAT_ADC_VAL_4) // ç”µæ± ç”µé‡å¤§äº4æ ¼
 187   2              {
 188   3                  cur_led_gear = 5; // äº®5æ ¼ï¼Œè®©ç¬¬5æ ¼é—ªçƒ
 189   3              }
 190   2              else if (bat_adc_val > BAT_ADC_VAL_3) // ç”µæ± ç”µé‡å¤§äº3æ ¼
 191   2              {
 192   3                  cur_led_gear = 4; // äº®4æ ¼ï¼Œè®©ç¬¬4æ ¼é—ªçƒ
 193   3              }
 194   2              else if (bat_adc_val > BAT_ADC_VAL_2) // ç”µæ± ç”µé‡å¤§äº2æ ¼
 195   2              {
 196   3                  cur_led_gear = 3; // äº®3æ ¼ï¼Œè®©ç¬¬3æ ¼é—ªçƒ
 197   3              }
 198   2              else if (bat_adc_val > BAT_ADC_VAL_1) // ç”µæ± ç”µé‡å¤§äº1æ ¼
 199   2              {
 200   3                  cur_led_gear = 2; // äº®2æ ¼ï¼Œè®©ç¬¬2æ ¼é—ªçƒ
 201   3              }
 202   2              else
 203   2              {
 204   3                  cur_led_gear = 1; // äº®1æ ¼ï¼Œè®©ç¬¬2æ ¼é—ªçƒ
 205   3              }
 206   2      
 207   2              if (CUR_CHARGE_PHASE_TRICKLE_CHARGE_WHEN_APPROACH_FULLY_CHARGE == cur_charge_phase || /* å¿«æ»¡ç”µ
             -ï¼Œæ¶“æµå……ç”µ */
 208   2                  CUR_CHARGE_PHASE_FULLY_CHARGE == cur_charge_phase)                                /* å·²ç»å……
             -æ»¡ç”µ */
 209   2              {
 210   3                  // æ ·æœºæ˜¯è¿›å…¥æ¶“æµå……ç”µæ‰æŠŠæ‰€æœ‰æŒ‡ç¤ºç¯å˜ä¸ºå¸¸äº®
 211   3                  cur_led_gear = 6;
 212   3              }
 213   2      
 214   2              if (0 == last_led_gear)
 215   2              {
 216   3                  last_led_gear = cur_led_gear;
 217   3              }
 218   2              else
 219   2              {
 220   3                  if (cur_led_gear < last_led_gear)
 221   3                  {
 222   4                      // åœ¨å……ç”µæŒ‡ç¤ºæ¨¡å¼ä¸­ï¼Œå¦‚æœç”µæ± ç”µé‡é™ä½ï¼Œä¸æ›´æ–°æ˜¾ç¤º
 223   4                      cur_led_gear = last_led_gear;
 224   4                  }
 225   3              }
 226   2      
 227   2              cur_led_gear_in_charging = cur_led_gear; // æ›´æ–°æ•°å€¼ï¼Œç»™å®šæ—¶å™¨ä¸­æ–­ä½¿ç”¨
 228   2              delay_ms(1);
 229   2      
 230   2              if (cur_led_gear >= 3)
 231   2              {
 232   3                  LED_2_ON();
 233   3              }
C51 COMPILER V9.60.7.0   LED_HANDLE                                                        07/18/2025 17:51:09 PAGE 5   

 234   2      
 235   2              if (cur_led_gear >= 4)
 236   2              {
 237   3                  LED_3_ON();
 238   3              }
 239   2      
 240   2              if (cur_led_gear >= 5)
 241   2              {
 242   3                  LED_4_ON();
 243   3              }
 244   2      
 245   2              if (cur_led_gear >= 6)
 246   2              {
 247   3                  LED_5_ON();
 248   3              }
 249   2          }
 250   1      
 251   1          if (flag_led_setting_mode_exit_times_come) // æ—¶é—´åˆ°æ¥ï¼Œå›åˆ°ç”µæ± ç”µé‡æŒ‡ç¤ºæ¨¡å¼
 252   1          {
 253   2              flag_led_setting_mode_exit_times_come = 0;
 254   2      
 255   2              // TODOï¼šè¿™é‡Œè¿˜æœªå¤„ç†å¥½åˆ‡æ¢é—®é¢˜
 256   2              if (cur_light_pwm_duty_val && /* å¦‚æœç¯å…‰è¿˜æ˜¯äº®ç€çš„ */
 257   2                  0 == flag_allow_light_in_setting_mode)
 258   2              {
 259   3                  cur_led_mode = CUR_LED_MODE_BAT_INDICATOR; // æ¢å¤åˆ°ç”µæ± ç”µé‡æŒ‡ç¤ºæ¨¡å¼
 260   3              }
 261   2              else // å¦‚æœç¯å…‰å·²ç»ç†„ç­
 262   2              {
 263   3                  cur_led_mode = CUR_LED_MODE_OFF; // æ¢å¤åˆ°å…³æœºæ¨¡å¼
 264   3              }
 265   2      
 266   2              flag_is_in_setting_mode = 0; // é€€å‡ºè®¾ç½®æ¨¡å¼
 267   2              flag_allow_light_in_setting_mode = 0;
 268   2          }
 269   1      
 270   1          // ledæŒ‡ç¤ºç¯é€€å‡ºæŒ‡ç¤ºæ¨¡å¼çš„æ—¶é—´åˆ°æ¥
 271   1          if (flag_is_led_mode_exit_times_come)
 272   1          {
 273   2              flag_is_led_mode_exit_times_come = 0;
 274   2              cur_led_mode = CUR_LED_MODE_OFF;
 275   2          }
 276   1      
 277   1          if (CUR_LED_MODE_OFF == cur_led_mode)
 278   1          {
 279   2              LED_1_OFF();
 280   2              LED_2_OFF();
 281   2              LED_3_OFF();
 282   2              LED_4_OFF();
 283   2              LED_5_OFF();
 284   2          }
 285   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    742    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
C51 COMPILER V9.60.7.0   LED_HANDLE                                                        07/18/2025 17:51:09 PAGE 6   

END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
