C51 COMPILER V9.60.7.0   LED_HANDLE                                                        07/19/2025 15:17:19 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE LED_HANDLE
OBJECT MODULE PLACED IN .\Release\Objects\led_handle.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\led_handle.c LARGE OPTIMIZE(8,SPEED) BROWSE INTVECTOR(0X000C)
                    - INCDIR(..\..\Libraries\Include;..\..\User;..\..\Hardware) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\Listings\led_h
                    -andle.lst) OBJECT(.\Release\Objects\led_handle.obj)

line level    source

   1          #include "led_handle.h"
   2          
   3          // åªèƒ½åˆšä¸Šç”µæ—¶è°ƒç”¨ï¼š
   4          void led_init(void)
   5          {
   6   1          led_all_off();
   7   1      
   8   1          last_led_gear = 0; // èµ‹å€¼ä¸ºåˆå§‹å€¼
   9   1          cur_led_gear_in_charging = 0;
  10   1          led_setting_mode_exit_times_cnt = 0; // æ¸…é™¤è®¾ç½®æ¨¡å¼ä¸‹çš„é€€å‡ºæ—¶é—´è®¡æ—¶
  11   1          flag_is_in_struction_mode = 0;
  12   1      }
  13          
  14          void led_all_off(void)
  15          {
  16   1          LED_1_OFF();
  17   1          LED_2_OFF();
  18   1          LED_3_OFF();
  19   1          LED_4_OFF();
  20   1          LED_5_OFF();
  21   1      }
  22          
  23          // æ¸…é™¤ledæœ‰å…³çš„çŠ¶æ€
  24          void led_status_clear(void)
  25          {
  26   1          led_all_off();
  27   1      
  28   1          flag_is_in_setting_mode = 0;
  29   1          flag_led_setting_mode_exit_times_come = 0;
  30   1          led_setting_mode_exit_times_cnt = 0;
  31   1      
  32   1          flag_is_in_struction_mode = 0;
  33   1          flag_led_struction_mode_exit_times_come = 0;
  34   1          led_struction_mode_exit_times_cnt = 0;
  35   1      
  36   1          // flag_is_led_off_enable = 0; // ä¸èƒ½åŠ å…¥è¿™å¥ï¼Œå¦‚æœé‡å¤æŒ‰ä¸‹SETæˆ–çº¢è‰²æŒ‰é”®ï¼Œä¼šå¯¼è‡
             -´æ— æ³•å…³æŒ‡ç¤ºç¯
  37   1      }
  38          
  39          /**
  40           * @brief æ›´æ”¹led_mode
  41           *
  42           * @param led_mode
  43           *              ç›¸å…³å®šä¹‰åœ¨ æšä¸¾ç±»å‹ CUR_LED_MODE_XXX ä¸­
  44          
  45           */
  46          void led_mode_alter(u8 led_mode)
  47          {
  48   1          led_all_off();
  49   1      
  50   1          cur_led_mode = led_mode;
  51   1      }
  52          
C51 COMPILER V9.60.7.0   LED_HANDLE                                                        07/19/2025 15:17:19 PAGE 2   

  53          /**
  54           * @brief åœ¨è®¾ç½®æ¨¡å¼ï¼Œè®¾ç½®åˆå§‹æ”¾ç”µæŒ¡ä½æˆ–æ”¾ç”µé€Ÿç‡
  55           *          å‡½æ•°å†…éƒ¨ä¼šåˆ¤æ–­ å½“å‰ æ˜¯å¦å¤„äºè®¾ç½®æ¨¡å¼
  56           *
  57           * @param set_led_mode
  58           *          CUR_LED_MODE_INITIAL_DISCHARGE_GEAR_IN_SETTING_MODE è¦è®¾ç½®çš„æ˜¯åˆå§‹æ”¾ç”µæŒ¡ä½
  59           *          CUR_LED_MODE_DISCHARGE_RATE_IN_SETTING_MODE     è¦è®¾ç½®çš„æ˜¯æ”¾ç”µé€Ÿç‡
  60           * @param val åˆå§‹æ”¾ç”µæŒ¡ä½ æˆ– æ”¾ç”µé€Ÿç‡å¯¹åº”çš„å€¼ï¼ˆéœ€è¦æ³¨æ„ä¸èƒ½è¶…è¿‡èŒƒå›´ï¼‰
  61           */
  62          void set_led_mode_status(u8 set_led_mode, u8 val)
  63          {
  64   1          // å¦‚æœåœ¨è®¾ç½®æ¨¡å¼ï¼Œæ‰ä¼šè¿›å…¥
  65   1          if (flag_is_in_setting_mode)
  66   1          {
  67   2              if (CUR_LED_MODE_INITIAL_DISCHARGE_GEAR_IN_SETTING_MODE == set_led_mode)
  68   2              {
  69   3                  cur_initial_discharge_gear = val;
  70   3      
  71   3                  // è®¾ç½®äº†åˆå§‹æŒ¡ä½ä¹‹åï¼Œæ›´æ–°å½“å‰ä¸»ç¯å…‰å¯¹åº”çš„å ç©ºæ¯”å€¼
  72   3                  cur_light_pwm_duty_val = light_pwm_duty_init_val_table[cur_initial_discharge_gear - 1];
  73   3              }
  74   2              else // CUR_LED_MODE_DISCHARGE_RATE_IN_SETTING_MODE == set_led_mode
  75   2              {
  76   3                  cur_discharge_rate = val;
  77   3              }
  78   2      
  79   2              cur_led_mode = set_led_mode;
  80   2              led_all_off();
  81   2              flag_led_setting_mode_exit_times_come = 0;
  82   2              led_setting_mode_exit_times_cnt = 0; // æ¸…ç©ºé€€å‡ºè®¾ç½®æ¨¡å¼çš„æ—¶é—´è®¡æ•°
  83   2      
  84   2              // led_status_clear();
  85   2      
  86   2              light_blink(val);
  87   2          }
  88   1      }
  89          
  90          //
  91          void led_handle(void)
  92          {
  93   1          // if (CUR_LED_MODE_OFF == cur_led_mode)
  94   1          // {
  95   1          //     // led_status_refresh();
  96   1          //     led_all_off();
  97   1      
  98   1          //     // last_led_mode = cur_led_mode;
  99   1          //     return;
 100   1          // }
 101   1      
 102   1          // å¦‚æœå½“å‰å¤„äºç”µæ± ç”µé‡æŒ‡ç¤ºæ¨¡å¼
 103   1          // è®¾å¤‡å¤„äºæ”¾ç”µæ—¶ï¼Œç”µé‡æŒ‡ç¤ºç¯åªæ˜¾ç¤ºç”µæ± ç”µé‡é™ä½çš„éƒ¨åˆ†
 104   1          if (CUR_LED_MODE_BAT_INDICATOR == cur_led_mode ||
 105   1              CUR_LED_MODE_BAT_INDICATIOR_IN_INSTRUCTION_MODE == cur_led_mode)
 106   1          {
 107   2              /* ç‚¹äº®æŒ‡ç¤ºç¯1ï¼ˆæ”¾ç”µæ¨¡å¼ï¼ŒæŒ‡ç¤ºç¯1å§‹ç»ˆç‚¹äº®ï¼‰ */
 108   2              LED_1_ON();
 109   2      
 110   2              if (bat_adc_val > BAT_ADC_VAL_4) // ç”µæ± ç”µé‡å¤§äº4æ ¼
 111   2              {
 112   3                  cur_led_gear = 5; // äº®5æ ¼
 113   3              }
 114   2              else if (bat_adc_val > BAT_ADC_VAL_3) // ç”µæ± ç”µé‡å¤§äº3æ ¼
C51 COMPILER V9.60.7.0   LED_HANDLE                                                        07/19/2025 15:17:19 PAGE 3   

 115   2              {
 116   3                  cur_led_gear = 4; // äº®4æ ¼
 117   3              }
 118   2              else if (bat_adc_val > BAT_ADC_VAL_2) // ç”µæ± ç”µé‡å¤§äº2æ ¼
 119   2              {
 120   3                  cur_led_gear = 3; // äº®3æ ¼
 121   3              }
 122   2              else if (bat_adc_val > BAT_ADC_VAL_1) // ç”µæ± ç”µé‡å¤§äº1æ ¼
 123   2              {
 124   3                  cur_led_gear = 2; // äº®2æ ¼
 125   3              }
 126   2              else
 127   2              {
 128   3                  cur_led_gear = 1; // äº®1æ ¼
 129   3              }
 130   2      
 131   2              if (0 == last_led_gear)
 132   2              {
 133   3                  // å¦‚æœæœªåˆå§‹åŒ–
 134   3                  last_led_gear = cur_led_gear;
 135   3              }
 136   2              else
 137   2              {
 138   3                  // å¦‚æœ last_led_gear ä¸ä¸º0ï¼Œåˆ™è¯´æ˜å·²ç»åˆå§‹åŒ–è¿‡äº†
 139   3      
 140   3                  if (cur_led_gear > last_led_gear)
 141   3                  {
 142   4                      // å¦‚æœå½“å‰è¦æ˜¾ç¤ºçš„æŒ‡ç¤ºç¯ å¤§äº ä¸Šæ¬¡æ˜¾ç¤ºçš„æŒ‡ç¤ºç¯ï¼ˆæ ·æœºåœ¨ç”µæ± ç”µå
             -‹ä¸Šå‡çš„æƒ…å†µä¸‹ï¼Œä¸ä¼šæ›´æ–°æ˜¾ç¤ºï¼‰
 143   4                      cur_led_gear = last_led_gear;
 144   4                  }
 145   3              }
 146   2      
 147   2              if (cur_led_gear >= 5)
 148   2              {
 149   3                  LED_5_ON();
 150   3              }
 151   2              else
 152   2              {
 153   3                  LED_5_OFF();
 154   3              }
 155   2      
 156   2              if (cur_led_gear >= 4)
 157   2              {
 158   3                  LED_4_ON();
 159   3              }
 160   2              else
 161   2              {
 162   3                  LED_4_OFF();
 163   3              }
 164   2      
 165   2              if (cur_led_gear >= 3)
 166   2              {
 167   3                  LED_3_ON();
 168   3              }
 169   2              else
 170   2              {
 171   3                  LED_3_OFF();
 172   3              }
 173   2      
 174   2              if (cur_led_gear >= 2)
 175   2              {
C51 COMPILER V9.60.7.0   LED_HANDLE                                                        07/19/2025 15:17:19 PAGE 4   

 176   3                  LED_2_ON();
 177   3              }
 178   2              else
 179   2              {
 180   3                  LED_2_OFF();
 181   3              }
 182   2      
 183   2          } // if (CUR_LED_MODE_BAT_INDICATOR == cur_led_mode)
 184   1          else if (CUR_LED_MODE_DISCHARGE_RATE_IN_SETTING_MODE == cur_led_mode ||
 185   1                   CUR_LED_MODE_DISCHARGE_RATE_IN_INSTRUCTION_MODE == cur_led_mode)
 186   1          {
 187   2              // æ”¾ç”µé€Ÿç‡æŒ‡ç¤ºæ¨¡å¼ï¼ŒM1ã€M2ã€M3ï¼Œéœ€è¦å¯¹åº”çš„æŒ‡ç¤ºç¯å¸¸äº®
 188   2              switch (cur_discharge_rate)
 189   2              {
 190   3              case 1:
 191   3                  LED_1_ON();
 192   3                  break;
 193   3              case 2:
 194   3                  LED_2_ON();
 195   3                  break;
 196   3              case 3:
 197   3                  LED_3_ON();
 198   3                  break;
 199   3              }
 200   2          }
 201   1          else if (CUR_LED_MODE_CHARGING == cur_led_mode) // å……ç”µæŒ‡ç¤ºæ¨¡å¼
 202   1          {
 203   2              // åœ¨å……ç”µæŒ‡ç¤ºæ¨¡å¼ä¸­ï¼Œå¦‚æœç”µæ± ç”µé‡é™ä½ï¼Œä¸æ›´æ–°æ˜¾ç¤º
 204   2              // TODOï¼šæ ·æœºæ˜¯åœ¨ç”µæ± ç”µå‹è¶…è¿‡3.55Vå¹¶ä¸”è¿›å…¥æ¶“æµå……ç”µï¼Œç»¿è‰²æŒ‡ç¤ºç¯æ‰ä¸€ç›´ç‚
             -¹äº®(ç¬¬5æ ¼æŒ‡ç¤ºç¯)
 205   2      
 206   2              /* ç‚¹äº®æŒ‡ç¤ºç¯1ï¼ˆæŒ‡ç¤ºç¯1å§‹ç»ˆç‚¹äº®ï¼‰ */
 207   2              LED_1_ON();
 208   2      
 209   2              // if (bat_adc_val > BAT_ADC_VAL_5) // ç”µæ± ç”µé‡å¤§äº5æ ¼
 210   2              // {
 211   2              //     cur_led_gear = 6; // äº®5æ ¼ï¼Œå¹¶ä¸”æ‰€æœ‰æŒ‡ç¤ºç¯å¸¸äº®
 212   2              // }
 213   2              // else if (bat_adc_val > BAT_ADC_VAL_4) // ç”µæ± ç”µé‡å¤§äº4æ ¼
 214   2              if (bat_adc_val > BAT_ADC_VAL_4) // ç”µæ± ç”µé‡å¤§äº4æ ¼
 215   2              {
 216   3                  cur_led_gear = 5; // äº®5æ ¼ï¼Œè®©ç¬¬5æ ¼é—ªçƒ
 217   3              }
 218   2              else if (bat_adc_val > BAT_ADC_VAL_3) // ç”µæ± ç”µé‡å¤§äº3æ ¼
 219   2              {
 220   3                  cur_led_gear = 4; // äº®4æ ¼ï¼Œè®©ç¬¬4æ ¼é—ªçƒ
 221   3              }
 222   2              else if (bat_adc_val > BAT_ADC_VAL_2) // ç”µæ± ç”µé‡å¤§äº2æ ¼
 223   2              {
 224   3                  cur_led_gear = 3; // äº®3æ ¼ï¼Œè®©ç¬¬3æ ¼é—ªçƒ
 225   3              }
 226   2              else if (bat_adc_val > BAT_ADC_VAL_1) // ç”µæ± ç”µé‡å¤§äº1æ ¼
 227   2              {
 228   3                  cur_led_gear = 2; // äº®2æ ¼ï¼Œè®©ç¬¬2æ ¼é—ªçƒ
 229   3              }
 230   2              else
 231   2              {
 232   3                  cur_led_gear = 1; // äº®1æ ¼ï¼Œè®©ç¬¬2æ ¼é—ªçƒ
 233   3              }
 234   2      
 235   2              if (CUR_CHARGE_PHASE_TRICKLE_CHARGE_WHEN_APPROACH_FULLY_CHARGE == cur_charge_phase || /* å¿«æ»¡ç”µ
             -ï¼Œæ¶“æµå……ç”µ */
C51 COMPILER V9.60.7.0   LED_HANDLE                                                        07/19/2025 15:17:19 PAGE 5   

 236   2                  CUR_CHARGE_PHASE_FULLY_CHARGE == cur_charge_phase)                                /* å·²ç»å……
             -æ»¡ç”µ */
 237   2              {
 238   3                  // æ ·æœºæ˜¯è¿›å…¥æ¶“æµå……ç”µæ‰æŠŠæ‰€æœ‰æŒ‡ç¤ºç¯å˜ä¸ºå¸¸äº®
 239   3                  cur_led_gear = 6;
 240   3              }
 241   2      
 242   2              if (0 == last_led_gear)
 243   2              {
 244   3                  last_led_gear = cur_led_gear;
 245   3              }
 246   2              else
 247   2              {
 248   3                  if (cur_led_gear < last_led_gear)
 249   3                  {
 250   4                      // åœ¨å……ç”µæŒ‡ç¤ºæ¨¡å¼ä¸­ï¼Œå¦‚æœç”µæ± ç”µé‡é™ä½ï¼Œä¸æ›´æ–°æ˜¾ç¤º
 251   4                      cur_led_gear = last_led_gear;
 252   4                  }
 253   3              }
 254   2      
 255   2              cur_led_gear_in_charging = cur_led_gear; // æ›´æ–°æ•°å€¼ï¼Œç»™å®šæ—¶å™¨ä¸­æ–­ä½¿ç”¨
 256   2              delay_ms(1);
 257   2      
 258   2              if (cur_led_gear >= 3)
 259   2              {
 260   3                  LED_2_ON();
 261   3              }
 262   2      
 263   2              if (cur_led_gear >= 4)
 264   2              {
 265   3                  LED_3_ON();
 266   3              }
 267   2      
 268   2              if (cur_led_gear >= 5)
 269   2              {
 270   3                  LED_4_ON();
 271   3              }
 272   2      
 273   2              if (cur_led_gear >= 6)
 274   2              {
 275   3                  LED_5_ON();
 276   3              }
 277   2          }
 278   1      
 279   1          // ledè®¾ç½®æ¨¡å¼çš„æ—¶é—´åˆ°æ¥
 280   1          if (flag_led_setting_mode_exit_times_come)
 281   1          {
 282   2              flag_led_setting_mode_exit_times_come = 0;
 283   2      
 284   2              flag_is_in_setting_mode = 0; // é€€å‡ºè®¾ç½®æ¨¡å¼
 285   2              flag_allow_light_in_setting_mode = 0;
 286   2      
 287   2              // å¦‚æœè¦å›åˆ° led_off
 288   2              if (flag_is_led_off_enable)
 289   2              {
 290   3                  flag_is_led_off_enable = 0;
 291   3                  cur_led_mode = CUR_LED_MODE_OFF;
 292   3              }
 293   2              else
 294   2              {
 295   3                  cur_led_mode = CUR_LED_MODE_BAT_INDICATOR; // æ¢å¤åˆ°ç”µæ± ç”µé‡æŒ‡ç¤ºæ¨¡å¼
 296   3              }
C51 COMPILER V9.60.7.0   LED_HANDLE                                                        07/19/2025 15:17:19 PAGE 6   

 297   2          }
 298   1      
 299   1          // ledæŒ‡ç¤ºç¯é€€å‡ºæŒ‡ç¤ºæ¨¡å¼çš„æ—¶é—´åˆ°æ¥
 300   1          if (flag_led_struction_mode_exit_times_come)
 301   1          {
 302   2              flag_led_struction_mode_exit_times_come = 0;
 303   2      
 304   2              flag_is_in_struction_mode = 0;
 305   2      
 306   2              // å¦‚æœè¦å›åˆ° led_off
 307   2              if (flag_is_led_off_enable)
 308   2              {
 309   3                  flag_is_led_off_enable = 0;
 310   3                  cur_led_mode = CUR_LED_MODE_OFF;
 311   3              }
 312   2              else
 313   2              {
 314   3                  cur_led_mode = CUR_LED_MODE_BAT_INDICATOR;
 315   3              }
 316   2          }
 317   1      
 318   1          if (CUR_LED_MODE_OFF == cur_led_mode)
 319   1          {
 320   2              led_all_off();
 321   2          }
 322   1      
 323   1          // last_led_mode = cur_led_mode;
 324   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    760    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
