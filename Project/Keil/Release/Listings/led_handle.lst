C51 COMPILER V9.60.7.0   LED_HANDLE                                                        07/21/2025 14:57:41 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE LED_HANDLE
OBJECT MODULE PLACED IN .\Release\Objects\led_handle.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\led_handle.c LARGE OPTIMIZE(8,SPEED) BROWSE INTVECTOR(0X000C)
                    - INCDIR(..\..\Libraries\Include;..\..\User;..\..\Hardware) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\Listings\led_h
                    -andle.lst) OBJECT(.\Release\Objects\led_handle.obj)

line level    source

   1          #include "led_handle.h"
   2          
   3          // åªèƒ½åˆšä¸Šç”µæ—¶è°ƒç”¨ï¼š
   4          void led_init(void)
   5          {
   6   1          led_all_off();
   7   1      
   8   1          last_led_gear = 0; // èµ‹å€¼ä¸ºåˆå§‹å€¼
   9   1          cur_led_gear_in_charging = 0;
  10   1          led_setting_mode_exit_times_cnt = 0; // æ¸…é™¤è®¾ç½®æ¨¡å¼ä¸‹çš„é€€å‡ºæ—¶é—´è®¡æ—¶
  11   1          flag_is_in_struction_mode = 0;
  12   1      }
  13          
  14          void led_all_off(void)
  15          {
  16   1          LED_1_OFF();
  17   1          LED_2_OFF();
  18   1          LED_3_OFF();
  19   1          LED_4_OFF();
  20   1          LED_5_OFF();
  21   1      }
  22          
  23          // æ¸…é™¤ledæœ‰å…³çš„çŠ¶æ€
  24          void led_status_clear(void)
  25          {
  26   1          led_all_off();
  27   1      
  28   1          // æ¸…ç©ºè®¾ç½®æ¨¡å¼ç›¸å…³çš„å˜é‡
  29   1          flag_is_in_setting_mode = 0;
  30   1          flag_led_setting_mode_exit_times_come = 0;
  31   1          led_setting_mode_exit_times_cnt = 0;
  32   1      
  33   1          // æ¸…ç©ºæŒ‡ç¤ºæ¨¡å¼ç›¸å…³çš„å˜é‡
  34   1          flag_is_in_struction_mode = 0;
  35   1          flag_led_struction_mode_exit_times_come = 0;
  36   1          led_struction_mode_exit_times_cnt = 0;
  37   1      
  38   1          // flag_is_led_off_enable = 0; // ä¸èƒ½åŠ å…¥è¿™å¥ï¼Œå¦‚æœé‡å¤æŒ‰ä¸‹SETæˆ–çº¢è‰²æŒ‰é”®ï¼Œä¼šå¯¼è‡
             -´æ— æ³•å…³æŒ‡ç¤ºç¯
  39   1      }
  40          
  41          /**
  42           * @brief æ›´æ”¹led_mode
  43           *
  44           * @param led_mode
  45           *              ç›¸å…³å®šä¹‰åœ¨ æšä¸¾ç±»å‹ CUR_LED_MODE_XXX ä¸­
  46          
  47           */
  48          void led_mode_alter(u8 led_mode)
  49          {
  50   1          led_all_off();
  51   1      
  52   1          cur_led_mode = led_mode;
C51 COMPILER V9.60.7.0   LED_HANDLE                                                        07/21/2025 14:57:41 PAGE 2   

  53   1      }
  54          
  55          /**
  56           * @brief åœ¨è®¾ç½®æ¨¡å¼ï¼Œè®¾ç½®åˆå§‹æ”¾ç”µæŒ¡ä½æˆ–æ”¾ç”µé€Ÿç‡
  57           *          å‡½æ•°å†…éƒ¨ä¼šåˆ¤æ–­ å½“å‰ æ˜¯å¦å¤„äºè®¾ç½®æ¨¡å¼
  58           *
  59           * @param set_led_mode
  60           *          CUR_LED_MODE_INITIAL_DISCHARGE_GEAR_IN_SETTING_MODE è¦è®¾ç½®çš„æ˜¯åˆå§‹æ”¾ç”µæŒ¡ä½
  61           *          CUR_LED_MODE_DISCHARGE_RATE_IN_SETTING_MODE     è¦è®¾ç½®çš„æ˜¯æ”¾ç”µé€Ÿç‡
  62           * @param val åˆå§‹æ”¾ç”µæŒ¡ä½ æˆ– æ”¾ç”µé€Ÿç‡å¯¹åº”çš„å€¼ï¼ˆéœ€è¦æ³¨æ„ä¸èƒ½è¶…è¿‡èŒƒå›´ï¼‰
  63           */
  64          void set_led_mode_status(u8 set_led_mode, u8 val)
  65          {
  66   1          // å¦‚æœåœ¨è®¾ç½®æ¨¡å¼ï¼Œæ‰ä¼šè¿›å…¥
  67   1          if (flag_is_in_setting_mode)
  68   1          {
  69   2              if (CUR_LED_MODE_INITIAL_DISCHARGE_GEAR_IN_SETTING_MODE == set_led_mode)
  70   2              {
  71   3                  cur_initial_discharge_gear = val;
  72   3      
  73   3                  // è®¾ç½®äº†åˆå§‹æŒ¡ä½ä¹‹åï¼Œæ›´æ–°å½“å‰ä¸»ç¯å…‰å¯¹åº”çš„å ç©ºæ¯”å€¼
  74   3                  cur_light_pwm_duty_val = light_pwm_duty_init_val_table[cur_initial_discharge_gear - 1];
  75   3              }
  76   2              else // CUR_LED_MODE_DISCHARGE_RATE_IN_SETTING_MODE == set_led_mode
  77   2              {
  78   3                  cur_discharge_rate = val;
  79   3              }
  80   2      
  81   2              cur_led_mode = set_led_mode;
  82   2              led_all_off();
  83   2              flag_led_setting_mode_exit_times_come = 0;
  84   2              led_setting_mode_exit_times_cnt = 0; // æ¸…ç©ºé€€å‡ºè®¾ç½®æ¨¡å¼çš„æ—¶é—´è®¡æ•°
  85   2      
  86   2              // led_status_clear();
  87   2      
  88   2              light_blink(val);
  89   2          }
  90   1      }
  91          
  92          //
  93          void led_handle(void)
  94          {
  95   1          // if (CUR_LED_MODE_OFF == cur_led_mode)
  96   1          // {
  97   1          //     // led_status_refresh();
  98   1          //     led_all_off();
  99   1      
 100   1          //     // last_led_mode = cur_led_mode;
 101   1          //     return;
 102   1          // }
 103   1      
 104   1          // å¦‚æœå½“å‰å¤„äºç”µæ± ç”µé‡æŒ‡ç¤ºæ¨¡å¼
 105   1          // è®¾å¤‡å¤„äºæ”¾ç”µæ—¶ï¼Œç”µé‡æŒ‡ç¤ºç¯åªæ˜¾ç¤ºç”µæ± ç”µé‡é™ä½çš„éƒ¨åˆ†
 106   1          if (CUR_LED_MODE_BAT_INDICATOR == cur_led_mode ||
 107   1              CUR_LED_MODE_BAT_INDICATIOR_IN_INSTRUCTION_MODE == cur_led_mode)
 108   1          {
 109   2              /* ç‚¹äº®æŒ‡ç¤ºç¯1ï¼ˆæ”¾ç”µæ¨¡å¼ï¼ŒæŒ‡ç¤ºç¯1å§‹ç»ˆç‚¹äº®ï¼‰ */
 110   2              LED_1_ON();
 111   2      
 112   2              if (bat_adc_val > BAT_ADC_VAL_4) // ç”µæ± ç”µé‡å¤§äº4æ ¼
 113   2              {
 114   3                  cur_led_gear = 5; // äº®5æ ¼
C51 COMPILER V9.60.7.0   LED_HANDLE                                                        07/21/2025 14:57:41 PAGE 3   

 115   3              }
 116   2              else if (bat_adc_val > BAT_ADC_VAL_3) // ç”µæ± ç”µé‡å¤§äº3æ ¼
 117   2              {
 118   3                  cur_led_gear = 4; // äº®4æ ¼
 119   3              }
 120   2              else if (bat_adc_val > BAT_ADC_VAL_2) // ç”µæ± ç”µé‡å¤§äº2æ ¼
 121   2              {
 122   3                  cur_led_gear = 3; // äº®3æ ¼
 123   3              }
 124   2              else if (bat_adc_val > BAT_ADC_VAL_1) // ç”µæ± ç”µé‡å¤§äº1æ ¼
 125   2              {
 126   3                  cur_led_gear = 2; // äº®2æ ¼
 127   3              }
 128   2              else
 129   2              {
 130   3                  cur_led_gear = 1; // äº®1æ ¼
 131   3              }
 132   2      
 133   2              if (0 == last_led_gear)
 134   2              {
 135   3                  // å¦‚æœæœªåˆå§‹åŒ–
 136   3                  last_led_gear = cur_led_gear;
 137   3              }
 138   2              else
 139   2              {
 140   3                  // å¦‚æœ last_led_gear ä¸ä¸º0ï¼Œåˆ™è¯´æ˜å·²ç»åˆå§‹åŒ–è¿‡äº†
 141   3      
 142   3                  if (cur_led_gear > last_led_gear)
 143   3                  {
 144   4                      // å¦‚æœå½“å‰è¦æ˜¾ç¤ºçš„æŒ‡ç¤ºç¯ å¤§äº ä¸Šæ¬¡æ˜¾ç¤ºçš„æŒ‡ç¤ºç¯ï¼ˆæ ·æœºåœ¨ç”µæ± ç”µå
             -‹ä¸Šå‡çš„æƒ…å†µä¸‹ï¼Œä¸ä¼šæ›´æ–°æ˜¾ç¤ºï¼‰
 145   4                      cur_led_gear = last_led_gear;
 146   4                  }
 147   3              }
 148   2      
 149   2              if (cur_led_gear >= 5)
 150   2              {
 151   3                  LED_5_ON();
 152   3              }
 153   2              else
 154   2              {
 155   3                  LED_5_OFF();
 156   3              }
 157   2      
 158   2              if (cur_led_gear >= 4)
 159   2              {
 160   3                  LED_4_ON();
 161   3              }
 162   2              else
 163   2              {
 164   3                  LED_4_OFF();
 165   3              }
 166   2      
 167   2              if (cur_led_gear >= 3)
 168   2              {
 169   3                  LED_3_ON();
 170   3              }
 171   2              else
 172   2              {
 173   3                  LED_3_OFF();
 174   3              }
 175   2      
C51 COMPILER V9.60.7.0   LED_HANDLE                                                        07/21/2025 14:57:41 PAGE 4   

 176   2              if (cur_led_gear >= 2)
 177   2              {
 178   3                  LED_2_ON();
 179   3              }
 180   2              else
 181   2              {
 182   3                  LED_2_OFF();
 183   3              }
 184   2      
 185   2          } // if (CUR_LED_MODE_BAT_INDICATOR == cur_led_mode)
 186   1          else if (CUR_LED_MODE_DISCHARGE_RATE_IN_SETTING_MODE == cur_led_mode ||
 187   1                   CUR_LED_MODE_DISCHARGE_RATE_IN_INSTRUCTION_MODE == cur_led_mode)
 188   1          {
 189   2              // æ”¾ç”µé€Ÿç‡æŒ‡ç¤ºæ¨¡å¼ï¼ŒM1ã€M2ã€M3ï¼Œéœ€è¦å¯¹åº”çš„æŒ‡ç¤ºç¯å¸¸äº®
 190   2              switch (cur_discharge_rate)
 191   2              {
 192   3              case 1:
 193   3                  LED_1_ON();
 194   3                  break;
 195   3              case 2:
 196   3                  LED_2_ON();
 197   3                  break;
 198   3              case 3:
 199   3                  LED_3_ON();
 200   3                  break;
 201   3              }
 202   2          }
 203   1          else if (CUR_LED_MODE_CHARGING == cur_led_mode) // å……ç”µæŒ‡ç¤ºæ¨¡å¼
 204   1          {
 205   2              // åœ¨å……ç”µæŒ‡ç¤ºæ¨¡å¼ä¸­ï¼Œå¦‚æœç”µæ± ç”µé‡é™ä½ï¼Œä¸æ›´æ–°æ˜¾ç¤º
 206   2              // TODOï¼šæ ·æœºæ˜¯åœ¨ç”µæ± ç”µå‹è¶…è¿‡3.55Vå¹¶ä¸”è¿›å…¥æ¶“æµå……ç”µï¼Œç»¿è‰²æŒ‡ç¤ºç¯æ‰ä¸€ç›´ç‚
             -¹äº®(ç¬¬5æ ¼æŒ‡ç¤ºç¯)
 207   2      
 208   2              /* ç‚¹äº®æŒ‡ç¤ºç¯1ï¼ˆæŒ‡ç¤ºç¯1å§‹ç»ˆç‚¹äº®ï¼‰ */
 209   2              LED_1_ON();
 210   2      
 211   2              // if (bat_adc_val > BAT_ADC_VAL_5) // ç”µæ± ç”µé‡å¤§äº5æ ¼
 212   2              // {
 213   2              //     cur_led_gear = 6; // äº®5æ ¼ï¼Œå¹¶ä¸”æ‰€æœ‰æŒ‡ç¤ºç¯å¸¸äº®
 214   2              // }
 215   2              // else if (bat_adc_val > BAT_ADC_VAL_4) // ç”µæ± ç”µé‡å¤§äº4æ ¼
 216   2              if (bat_adc_val > BAT_ADC_VAL_4) // ç”µæ± ç”µé‡å¤§äº4æ ¼
 217   2              {
 218   3                  cur_led_gear = 5; // äº®5æ ¼ï¼Œè®©ç¬¬5æ ¼é—ªçƒ
 219   3              }
 220   2              else if (bat_adc_val > BAT_ADC_VAL_3) // ç”µæ± ç”µé‡å¤§äº3æ ¼
 221   2              {
 222   3                  cur_led_gear = 4; // äº®4æ ¼ï¼Œè®©ç¬¬4æ ¼é—ªçƒ
 223   3              }
 224   2              else if (bat_adc_val > BAT_ADC_VAL_2) // ç”µæ± ç”µé‡å¤§äº2æ ¼
 225   2              {
 226   3                  cur_led_gear = 3; // äº®3æ ¼ï¼Œè®©ç¬¬3æ ¼é—ªçƒ
 227   3              }
 228   2              else if (bat_adc_val > BAT_ADC_VAL_1) // ç”µæ± ç”µé‡å¤§äº1æ ¼
 229   2              {
 230   3                  cur_led_gear = 2; // äº®2æ ¼ï¼Œè®©ç¬¬2æ ¼é—ªçƒ
 231   3              }
 232   2              else
 233   2              {
 234   3                  cur_led_gear = 1; // äº®1æ ¼ï¼Œè®©ç¬¬2æ ¼é—ªçƒ
 235   3              }
 236   2      
C51 COMPILER V9.60.7.0   LED_HANDLE                                                        07/21/2025 14:57:41 PAGE 5   

 237   2              if (CUR_CHARGE_PHASE_TRICKLE_CHARGE_WHEN_APPROACH_FULLY_CHARGE == cur_charge_phase || /* å¿«æ»¡ç”µ
             -ï¼Œæ¶“æµå……ç”µ */
 238   2                  CUR_CHARGE_PHASE_FULLY_CHARGE == cur_charge_phase)                                /* å·²ç»å……
             -æ»¡ç”µ */
 239   2              {
 240   3                  // æ ·æœºæ˜¯è¿›å…¥æ¶“æµå……ç”µæ‰æŠŠæ‰€æœ‰æŒ‡ç¤ºç¯å˜ä¸ºå¸¸äº®
 241   3                  cur_led_gear = 6;
 242   3              }
 243   2      
 244   2              if (0 == last_led_gear)
 245   2              {
 246   3                  last_led_gear = cur_led_gear;
 247   3              }
 248   2              else
 249   2              {
 250   3                  if (cur_led_gear < last_led_gear)
 251   3                  {
 252   4                      // åœ¨å……ç”µæŒ‡ç¤ºæ¨¡å¼ä¸­ï¼Œå¦‚æœç”µæ± ç”µé‡é™ä½ï¼Œä¸æ›´æ–°æ˜¾ç¤º
 253   4                      cur_led_gear = last_led_gear;
 254   4                  }
 255   3              }
 256   2      
 257   2              cur_led_gear_in_charging = cur_led_gear; // æ›´æ–°æ•°å€¼ï¼Œç»™å®šæ—¶å™¨ä¸­æ–­ä½¿ç”¨
 258   2              delay_ms(1);
 259   2      
 260   2              if (cur_led_gear >= 3)
 261   2              {
 262   3                  LED_2_ON();
 263   3              }
 264   2      
 265   2              if (cur_led_gear >= 4)
 266   2              {
 267   3                  LED_3_ON();
 268   3              }
 269   2      
 270   2              if (cur_led_gear >= 5)
 271   2              {
 272   3                  LED_4_ON();
 273   3              }
 274   2      
 275   2              if (cur_led_gear >= 6)
 276   2              {
 277   3                  LED_5_ON();
 278   3              }
 279   2          }
 280   1      
 281   1          // ledè®¾ç½®æ¨¡å¼çš„æ—¶é—´åˆ°æ¥
 282   1          if (flag_led_setting_mode_exit_times_come)
 283   1          {
 284   2              flag_led_setting_mode_exit_times_come = 0;
 285   2      
 286   2              flag_is_in_setting_mode = 0; // é€€å‡ºè®¾ç½®æ¨¡å¼
 287   2              flag_allow_light_in_setting_mode = 0;
 288   2      
 289   2              // å¦‚æœè¦å›åˆ° led_off
 290   2              if (flag_is_led_off_enable)
 291   2              {
 292   3                  flag_is_led_off_enable = 0;
 293   3                  cur_led_mode = CUR_LED_MODE_OFF;
 294   3              }
 295   2              else
 296   2              {
C51 COMPILER V9.60.7.0   LED_HANDLE                                                        07/21/2025 14:57:41 PAGE 6   

 297   3                  cur_led_mode = CUR_LED_MODE_BAT_INDICATOR; // æ¢å¤åˆ°ç”µæ± ç”µé‡æŒ‡ç¤ºæ¨¡å¼
 298   3              }
 299   2          }
 300   1      
 301   1          // ledæŒ‡ç¤ºç¯é€€å‡ºæŒ‡ç¤ºæ¨¡å¼çš„æ—¶é—´åˆ°æ¥
 302   1          if (flag_led_struction_mode_exit_times_come)
 303   1          {
 304   2              flag_led_struction_mode_exit_times_come = 0;
 305   2      
 306   2              flag_is_in_struction_mode = 0;
 307   2      
 308   2              // å¦‚æœè¦å›åˆ° led_off
 309   2              if (flag_is_led_off_enable)
 310   2              {
 311   3                  flag_is_led_off_enable = 0;
 312   3                  cur_led_mode = CUR_LED_MODE_OFF;
 313   3              }
 314   2              else
 315   2              {
 316   3                  cur_led_mode = CUR_LED_MODE_BAT_INDICATOR;
 317   3              }
 318   2          }
 319   1      
 320   1          if (CUR_LED_MODE_OFF == cur_led_mode)
 321   1          {
 322   2              led_all_off();
 323   2          }
 324   1      
 325   1          // last_led_mode = cur_led_mode;
 326   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    760    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
